<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAW Desk Assessment - Baggao</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: clamp(8px, 2vw, 20px);
        }

        .container {
            max-width: min(95vw, 900px);
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #2c5aa0;
            color: white;
            padding: clamp(16px, 4vw, 24px);
            text-align: center;
        }

        .header h1 {
            font-size: clamp(18px, 4vw, 22px);
            margin-bottom: 6px;
            font-weight: 600;
        }

        .header p {
            font-size: clamp(13px, 3vw, 15px);
            opacity: 0.95;
        }

        .progress-bar {
            height: 6px;
            background: #e8eaed;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: #28a745;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            padding: 10px;
            font-size: clamp(11px, 2.5vw, 13px);
            color: #5f6368;
            background: #fafbfc;
        }

        .content {
            padding: clamp(16px, 4vw, 24px);
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: clamp(17px, 4vw, 20px);
            font-weight: 600;
            color: #1a73e8;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 3px solid #1a73e8;
        }

        .barangay-info {
            background: #e8f0fe;
            padding: clamp(12px, 3vw, 16px);
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #1a73e8;
        }

        .barangay-info strong {
            display: block;
            color: #1967d2;
            margin-bottom: 6px;
            font-size: clamp(13px, 3vw, 14px);
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #202124;
            font-size: clamp(13px, 3vw, 15px);
            line-height: 1.5;
        }

        .form-group select,
        .form-group input[type="date"] {
            width: 100%;
            padding: clamp(10px, 2.5vw, 14px);
            border: 2px solid #dadce0;
            border-radius: 8px;
            font-size: clamp(14px, 3.5vw, 16px);
            transition: all 0.2s;
            background: white;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        .radio-group,
        .checkbox-group {
            background: #f8f9fa;
            padding: clamp(12px, 3vw, 16px);
            border-radius: 8px;
            margin-top: 12px;
        }

        .radio-option,
        .checkbox-option {
            display: flex;
            align-items: center;
            padding: clamp(14px, 3.5vw, 18px);
            background: white;
            border: 2px solid #dadce0;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 56px;
        }

        .radio-option:hover,
        .checkbox-option:hover {
            border-color: #1a73e8;
            background: #f1f8ff;
            transform: translateX(4px);
        }

        .radio-option.selected,
        .checkbox-option.checked {
            border-color: #1e8e3e;
            background: #e6f4ea;
        }

        .radio-option input[type="radio"],
        .checkbox-option input[type="checkbox"] {
            width: 24px;
            height: 24px;
            min-width: 24px;
            margin-right: 16px;
            cursor: pointer;
            accent-color: #1a73e8;
        }

        .radio-option label,
        .checkbox-option label {
            flex: 1;
            cursor: pointer;
            margin: 0;
            font-weight: 400;
            font-size: clamp(13px, 3.5vw, 15px);
            line-height: 1.5;
            padding: 4px 0;
        }

        .point-badge {
            background: #1a73e8;
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: clamp(11px, 2.5vw, 13px);
            font-weight: 600;
            margin-left: 12px;
            white-space: nowrap;
        }

        .score-display {
            background: #1e8e3e;
            color: white;
            padding: clamp(16px, 4vw, 20px);
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .score-display .big-score {
            font-size: clamp(32px, 8vw, 42px);
            font-weight: 700;
            margin: 12px 0;
        }

        .score-display .label {
            font-size: clamp(12px, 3vw, 14px);
            opacity: 0.95;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 32px;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 140px;
            padding: clamp(12px, 3vw, 16px) clamp(16px, 4vw, 24px);
            border: none;
            border-radius: 8px;
            font-size: clamp(14px, 3.5vw, 16px);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-previous {
            background: #5f6368;
            color: white;
        }

        .btn-previous:hover {
            background: #4a4f54;
        }

        .btn-previous:active {
            transform: scale(0.98);
        }

        .btn-next {
            background: #1a73e8;
            color: white;
        }

        .btn-next:hover {
            background: #1557b0;
        }

        .btn-next:active {
            transform: scale(0.98);
        }

        .btn-submit {
            background: #1e8e3e;
            color: white;
        }

        .btn-submit:hover {
            background: #137333;
        }

        .btn-submit:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            background: #dadce0;
            color: #80868b;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .summary-section {
            background: #f8f9fa;
            padding: clamp(14px, 3.5vw, 18px);
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid #e8eaed;
        }

        .summary-section h3 {
            color: #1a73e8;
            font-size: clamp(15px, 3.5vw, 17px);
            margin-bottom: 12px;
            font-weight: 600;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e8eaed;
            font-size: clamp(13px, 3vw, 14px);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .alert {
            padding: clamp(14px, 3.5vw, 16px);
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: clamp(13px, 3vw, 14px);
            line-height: 1.6;
        }

        .alert-success {
            background: #e6f4ea;
            color: #137333;
            border-left: 4px solid #1e8e3e;
        }

        .alert-info {
            background: #e8f0fe;
            color: #185abc;
            border-left: 4px solid #1a73e8;
        }

        .alert-warning {
            background: #fef7e0;
            color: #b45309;
            border-left: 4px solid #f9ab00;
        }

        .loading {
            text-align: center;
            padding: 24px;
        }

        .spinner {
            border: 4px solid #e8eaed;
            border-top: 4px solid #1a73e8;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .dashboard {
            padding: clamp(16px, 4vw, 24px);
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .dashboard-header h2 {
            color: #202124;
            font-size: clamp(20px, 5vw, 24px);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .dashboard-header p {
            color: #5f6368;
            font-size: clamp(13px, 3vw, 14px);
        }

        .progress-summary {
            background: #1a73e8;
            color: white;
            padding: clamp(20px, 5vw, 28px);
            border-radius: 12px;
            text-align: center;
            margin-bottom: 28px;
        }

        .progress-summary .label {
            font-size: clamp(13px, 3vw, 14px);
            opacity: 0.95;
            margin-bottom: 8px;
        }

        .progress-summary .big-number {
            font-size: clamp(40px, 10vw, 52px);
            font-weight: 700;
            margin: 12px 0;
        }

        .barangay-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(140px, 100%), 1fr));
            gap: clamp(10px, 2.5vw, 14px);
            margin-bottom: 28px;
        }

        .barangay-card {
            background: white;
            border: 2px solid #dadce0;
            border-radius: 8px;
            padding: clamp(12px, 3vw, 16px);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .barangay-card:hover {
            border-color: #1a73e8;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.15);
        }

        .barangay-card.completed {
            background: #e6f4ea;
            border-color: #1e8e3e;
        }

        .barangay-card.in-progress {
            background: #fef7e0;
            border-color: #f9ab00;
        }

        .barangay-card .name {
            font-weight: 600;
            font-size: clamp(12px, 3vw, 14px);
            color: #202124;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .barangay-card .score {
            font-size: clamp(18px, 4.5vw, 22px);
            font-weight: 700;
            color: #1a73e8;
        }

        .barangay-card .status {
            font-size: clamp(10px, 2.5vw, 12px);
            color: #5f6368;
            margin-top: 6px;
        }

        .submit-section {
            background: #f8f9fa;
            padding: clamp(20px, 5vw, 28px);
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e8eaed;
        }

        .submit-section h3 {
            color: #202124;
            font-size: clamp(16px, 4vw, 18px);
            margin-bottom: 12px;
        }

        .submit-section p {
            color: #5f6368;
            font-size: clamp(13px, 3vw, 14px);
            margin-bottom: 16px;
        }

        .submit-section .btn {
            max-width: 400px;
            margin: 12px auto;
            display: block;
            width: 100%;
        }

        @media (max-width: 600px) {
            .barangay-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        @media (min-width: 601px) and (max-width: 900px) {
            .barangay-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .hidden {
            display: none;
        }

        /* ===================================
           TOP NAVIGATION BAR
        =================================== */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            color: #202124;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 clamp(16px, 4vw, 32px);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid #e8eaed;
            z-index: 1000;
            backdrop-filter: blur(8px);
        }

        .top-nav-title {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #1a73e8;
            letter-spacing: -0.2px;
        }

        .top-nav-title span:first-child {
            font-size: 24px;
        }

        .top-nav-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .nav-btn {
            background: transparent;
            border: 1px solid transparent;
            color: #5f6368;
            font-size: 20px;
            cursor: pointer;
            padding: 10px 16px;
            border-radius: 12px;
            min-width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
            position: relative;
            white-space: nowrap;
        }

        .nav-btn-text {
            font-size: 14px;
            font-weight: 500;
            display: none;
        }

        .nav-btn:hover {
            background: #f1f3f4;
            color: #1a73e8;
            border-color: #e8eaed;
            transform: translateY(-1px);
        }

        .nav-btn:active {
            background: #e8eaed;
            transform: translateY(0);
        }

        @media (min-width: 768px) {
            .nav-btn-text {
                display: inline;
            }

            .nav-btn {
                padding: 10px 18px;
            }
        }

        /* Adjust body padding for fixed nav */
        body {
            padding-top: 72px;
        }

        /* ===================================
           MODAL SYSTEM
        =================================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 540px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.15), 0 0 1px rgba(0, 0, 0, 0.1);
            animation: modalSlideIn 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            background: white;
            border-bottom: 1px solid #e8eaed;
            color: #202124;
            padding: 24px 24px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 22px;
            font-weight: 600;
            color: #202124;
        }

        .modal-close {
            background: transparent;
            border: 1px solid transparent;
            color: #5f6368;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #f1f3f4;
            color: #202124;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-section {
            margin-bottom: 28px;
        }

        .modal-section:last-child {
            margin-bottom: 0;
        }

        .modal-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: #5f6368;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-section p {
            font-size: 14px;
            color: #5f6368;
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .modal-section p strong {
            color: #202124;
            font-weight: 600;
        }

        /* ===================================
           FOLDER STATUS INDICATOR
        =================================== */
        .folder-status {
            background: #f8f9fa;
            border: 1px solid #e8eaed;
            border-left: 4px solid #1a73e8;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .folder-status.success {
            background: #f1f8f4;
            border-left-color: #1e8e3e;
        }

        .folder-status.warning {
            background: #fef9f0;
            border-left-color: #f9ab00;
        }

        .folder-status-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .folder-status-icon {
            font-size: 24px;
        }

        .folder-status-title {
            font-size: 15px;
            font-weight: 600;
            color: #202124;
        }

        .folder-list {
            margin-left: 34px;
            font-size: 13px;
            color: #5f6368;
        }

        .folder-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid #e8eaed;
        }

        .folder-item:last-child {
            border-bottom: none;
        }

        .folder-item-icon {
            font-size: 16px;
        }

        .modal-btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .modal-btn {
            flex: 1;
            min-width: 140px;
            padding: 14px 20px;
            border: 1px solid transparent;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .modal-btn-primary {
            background: #1a73e8;
            color: white;
            box-shadow: 0 1px 3px rgba(26, 115, 232, 0.3);
        }

        .modal-btn-primary:hover {
            background: #1557b0;
            box-shadow: 0 2px 6px rgba(26, 115, 232, 0.4);
            transform: translateY(-1px);
        }

        .modal-btn-success {
            background: #1e8e3e;
            color: white;
            box-shadow: 0 1px 3px rgba(30, 142, 62, 0.3);
        }

        .modal-btn-success:hover {
            background: #137333;
            box-shadow: 0 2px 6px rgba(30, 142, 62, 0.4);
            transform: translateY(-1px);
        }

        .modal-btn-warning {
            background: #f9ab00;
            color: white;
            box-shadow: 0 1px 3px rgba(249, 171, 0, 0.3);
        }

        .modal-btn-warning:hover {
            background: #e69500;
            box-shadow: 0 2px 6px rgba(249, 171, 0, 0.4);
            transform: translateY(-1px);
        }

        .modal-btn-danger {
            background: #d93025;
            color: white;
            box-shadow: 0 1px 3px rgba(217, 48, 37, 0.3);
        }

        .modal-btn-danger:hover {
            background: #b31412;
            box-shadow: 0 2px 6px rgba(217, 48, 37, 0.4);
            transform: translateY(-1px);
        }

        .modal-btn:active {
            transform: translateY(0);
        }

        /* Action Cards for Quick Actions */
        .action-grid {
            display: grid;
            gap: 12px;
            margin-top: 12px;
        }

        .action-card {
            background: white;
            border: 1px solid #e8eaed;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            font-family: inherit;
        }

        .action-card:hover {
            background: #f8f9fa;
            border-color: #dadce0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .action-card:active {
            transform: translateY(0);
        }

        .action-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
        }

        .action-card-primary .action-icon {
            background: #e8f0fe;
        }

        .action-card-warning .action-icon {
            background: #fef7e0;
        }

        .action-card-success .action-icon {
            background: #e6f4ea;
        }

        .action-card-danger .action-icon {
            background: #fce8e6;
        }

        .action-text {
            flex: 1;
        }

        .action-title {
            font-size: 15px;
            font-weight: 600;
            color: #202124;
            margin-bottom: 2px;
        }

        .action-desc {
            font-size: 13px;
            color: #5f6368;
        }

        @media (max-width: 600px) {
            .modal-content {
                max-width: calc(100vw - 32px);
                border-radius: 12px;
            }

            .modal-header {
                padding: 20px 16px 16px;
            }

            .modal-header h2 {
                font-size: 20px;
            }

            .modal-body {
                padding: 20px 16px;
            }

            .modal-section {
                margin-bottom: 24px;
            }

            .modal-btn-group {
                flex-direction: column;
                gap: 10px;
            }

            .modal-btn {
                width: 100%;
                padding: 12px 18px;
            }

            .action-card {
                padding: 14px;
                gap: 12px;
            }

            .action-icon {
                width: 44px;
                height: 44px;
                font-size: 20px;
            }

            .action-title {
                font-size: 14px;
            }

            .action-desc {
                font-size: 12px;
            }

            .top-nav {
                height: 56px;
                padding: 0 12px;
            }

            .top-nav-title {
                font-size: 17px;
                gap: 8px;
            }

            .top-nav-title span:first-child {
                font-size: 20px;
            }

            .nav-btn {
                min-width: 40px;
                height: 40px;
                padding: 8px 10px;
                font-size: 18px;
                gap: 6px;
            }

            .top-nav-actions {
                gap: 6px;
            }

            body {
                padding-top: 64px;
            }
        }

        /* Developer Footer Badge */
        .developer-footer {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
        }

        .footer-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #1a73e8 0%, #1557b0 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
            transition: all 0.3s ease;
            cursor: default;
        }

        .footer-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(26, 115, 232, 0.4);
        }

        .footer-icon {
            width: 18px;
            height: 18px;
            background: white;
            color: #1a73e8;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
        }

        @media (max-width: 600px) {
            .developer-footer {
                padding: 15px;
            }

            .footer-badge {
                font-size: 11px;
                padding: 8px 16px;
            }

            .footer-icon {
                width: 16px;
                height: 16px;
                font-size: 10px;
            }
        }

        /* ============================================ */
        /* LONG-PRESS UNLOCK FEATURE */
        /* ============================================ */

        /* Progress ring for long-press */
        .long-press-progress {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .long-press-progress.active {
            opacity: 1;
        }

        .long-press-progress svg {
            transform: rotate(-90deg);
        }

        .long-press-progress circle {
            fill: none;
            stroke-width: 6;
        }

        .progress-bg {
            stroke: #e0e0e0;
        }

        .progress-fill {
            stroke: #8B5CF6;
            stroke-dasharray: 226;
            stroke-dashoffset: 226;
            transition: stroke-dashoffset 0.1s linear;
        }

        .barangay-card.pressing {
            transform: scale(0.95);
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.4);
            border: 2px solid #8B5CF6;
        }

        /* PIN Verification Modal */
        .unlock-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .unlock-modal.show {
            display: flex;
        }

        .unlock-modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .unlock-modal-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .unlock-modal-header h2 {
            color: #8B5CF6;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .unlock-modal-header p {
            color: #666;
            font-size: 14px;
        }

        .unlock-barangay-name {
            background: #F3E8FF;
            color: #8B5CF6;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .unlock-pin-boxes {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .unlock-pin-box {
            width: 50px;
            height: 50px;
            border: 2px solid #DDD6FE;
            border-radius: 12px;
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            color: #8B5CF6;
            outline: none;
            transition: all 0.3s ease;
            background: #F9FAFB;
        }

        .unlock-pin-box:focus {
            border-color: #8B5CF6;
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
            background: white;
        }

        .unlock-modal-buttons {
            display: flex;
            gap: 10px;
        }

        .unlock-modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .unlock-modal-btn.verify {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .unlock-modal-btn.verify:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
        }

        .unlock-modal-btn.cancel {
            background: #E5E7EB;
            color: #374151;
        }

        .unlock-modal-btn.cancel:hover {
            background: #D1D5DB;
        }

        .unlock-error {
            background: #FEE2E2;
            color: #DC2626;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-top: 12px;
            display: none;
            text-align: center;
            animation: shake 0.5s ease;
        }

        .unlock-error.show {
            display: block;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Edited Badge */
        .edited-badge {
            display: inline-block;
            background: #FFA500;
            color: white;
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 6px;
            font-weight: 600;
        }

        .edit-history-icon {
            cursor: help;
            margin-left: 4px;
        }
    </style>
</head>
<body>
    <!-- TOP NAVIGATION BAR -->
    <div class="top-nav">
        <div class="top-nav-title">
            <span>üìã</span>
            <span id="navTitle">VAW Assessment</span>
        </div>
        <div class="top-nav-actions">
            <button class="nav-btn" onclick="openFileOrgModal()" title="File Organization">
                <span>üìÅ</span>
                <span class="nav-btn-text">Files</span>
            </button>
            <button class="nav-btn" onclick="openRecoveryModal()" title="Data Recovery">
                <span>üîÑ</span>
                <span class="nav-btn-text">Recovery</span>
            </button>
            <button class="nav-btn" onclick="openMenuModal()" title="Menu">
                <span>‚ãÆ</span>
                <span class="nav-btn-text">Menu</span>
            </button>
        </div>
    </div>

    <!-- MODAL: File Organization -->
    <div class="modal-overlay" id="fileOrgModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>File Organization</h2>
                <button class="modal-close" onclick="closeModal('fileOrgModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Folder Status Indicator -->
                <div class="folder-status" id="folderStatusIndicator">
                    <div class="folder-status-header">
                        <span class="folder-status-icon" id="folderStatusIcon">üìÇ</span>
                        <span class="folder-status-title" id="folderStatusTitle">Checking folder status...</span>
                    </div>
                    <div class="folder-list" id="folderStatusList"></div>
                </div>

                <div class="modal-section">
                    <h3>About File Organization</h3>
                    <p>This feature creates organized folders for your JSON backup files automatically when you save assessments.</p>

                    <p><strong>Folder Structure:</strong></p>
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 13px; margin-bottom: 12px;">
                        üìÇ VAW_Assessments/<br>
                        &nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ üìÇ barangay/ (48 individual files)<br>
                        &nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ üìÇ progress/ (incremental backups)<br>
                        &nbsp;&nbsp;&nbsp;‚îî‚îÄ‚îÄ üìÇ final/ (final submission)
                    </div>
                </div>

                <div class="modal-section">
                    <h3>Setup Folder Organization</h3>
                    <p>Click below to enable organized folder creation (Chrome/Edge 86+ only). Files will be organized automatically when saving.</p>

                    <div class="modal-btn-group">
                        <button class="modal-btn modal-btn-primary" onclick="requestFolderPermission(); checkFolderStatus();">
                            üóÇÔ∏è Enable Folder Organization
                        </button>
                    </div>
                </div>

                <div class="modal-section">
                    <h3>Alternative (Older Devices)</h3>
                    <p style="font-size: 13px;">If folder organization is not available, files will download with folder prefixes in the filename (e.g., VAW_BARANGAY_Adaoag.json). You can organize them manually.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Data Recovery -->
    <div class="modal-overlay" id="recoveryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Data Recovery</h2>
                <button class="modal-close" onclick="closeModal('recoveryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-section">
                    <h3>Restore from Backup</h3>
                    <p>If your browser data was accidentally cleared, you can restore all assessments from your backup JSON files.</p>

                    <p><strong>Supported file types:</strong></p>
                    <ul style="margin-left: 20px; margin-bottom: 12px; color: #5f6368;">
                        <li>Individual barangay files (VAW_BARANGAY_*.json)</li>
                        <li>Progress backup files (VAW_PROGRESS_*.json)</li>
                        <li>Final submission files (VAW_FINAL_*.json)</li>
                        <li>Manual backup files (BACKUP_*.json)</li>
                    </ul>

                    <div class="modal-btn-group">
                        <button class="modal-btn modal-btn-warning" onclick="document.getElementById('importFileInput').click(); closeModal('recoveryModal');">
                            üì• Load Data from JSON
                        </button>
                        <button class="modal-btn modal-btn-primary" onclick="autoLoadLatestProgress(); closeModal('recoveryModal');" style="margin-top: 12px;">
                            üîÑ Auto-Load Latest Progress
                        </button>
                    </div>
                    <p style="font-size: 12px; color: #5f6368; margin-top: 8px; font-style: italic;">
                        üí° Auto-Load searches your designated folder for the latest Progress backup file
                    </p>
                </div>

                <div class="modal-section">
                    <h3>Create Manual Backup</h3>
                    <p>Create a complete backup of all current assessments. Keep this file safe for recovery!</p>

                    <div class="modal-btn-group">
                        <button class="modal-btn modal-btn-success" onclick="exportAllDataAsBackup(); closeModal('recoveryModal');">
                            üíæ Create Full Backup Now
                        </button>
                    </div>
                </div>

                <!-- <div class="modal-section">
                    <h3>Clear All Data</h3>
                    <p style="color: #d93025;"><strong>‚ö†Ô∏è Danger Zone:</strong> This will permanently delete all assessments from this device. Make sure you have backups first!</p>

                    <div class="modal-btn-group">
                        <button class="modal-btn modal-btn-danger" onclick="clearAllDataConfirm(); closeModal('recoveryModal');">
                            üóëÔ∏è Clear All Data
                        </button>
                    </div>
                </div> -->
            </div>
        </div>
    </div>

    <!-- MODAL: Main Menu -->
    <div class="modal-overlay" id="menuModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Menu</h2>
                <button class="modal-close" onclick="closeModal('menuModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-section" id="userInfoSection">
                    <h3>Account</h3>
                    <div style="background: #f8f9fa; border: 1px solid #e8eaed; padding: 16px; border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #1a73e8 0%, #1557b0 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; font-weight: 600;">üë§</div>
                            <div style="flex: 1;">
                                <p style="margin: 0; font-weight: 600; color: #202124; font-size: 15px;" id="loggedInUserName">Loading...</p>
                                <p style="margin: 4px 0 0 0; font-size: 13px; color: #5f6368;" id="loggedInUserPosition">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-section">
                    <h3>Quick Actions</h3>
                    <div class="action-grid">
                        <button class="action-card action-card-primary" onclick="openFileOrgModal(); closeModal('menuModal');">
                            <div class="action-icon">üìÅ</div>
                            <div class="action-text">
                                <div class="action-title">File Organization</div>
                                <div class="action-desc">Manage assessment files</div>
                            </div>
                        </button>
                        <button class="action-card action-card-warning" onclick="openRecoveryModal(); closeModal('menuModal');">
                            <div class="action-icon">üîÑ</div>
                            <div class="action-text">
                                <div class="action-title">Data Recovery</div>
                                <div class="action-desc">Restore from backup</div>
                            </div>
                        </button>
                        <button class="action-card action-card-success" onclick="exportAllDataAsBackup(); closeModal('menuModal');">
                            <div class="action-icon">üíæ</div>
                            <div class="action-text">
                                <div class="action-title">Create Backup</div>
                                <div class="action-desc">Export all data</div>
                            </div>
                        </button>
                        <button class="action-card action-card-warning" onclick="openFactoryResetModal(); closeModal('menuModal');" style="border: 2px solid #FF6B35;">
                            <div class="action-icon">üîß</div>
                            <div class="action-text">
                                <div class="action-title">Factory Reset</div>
                                <div class="action-desc">Demo/Testing Only</div>
                            </div>
                        </button>
                        <button class="action-card action-card-danger" onclick="handleLogout()">
                            <div class="action-icon">üö™</div>
                            <div class="action-text">
                                <div class="action-title">Logout</div>
                                <div class="action-desc">Sign out of account</div>
                            </div>
                        </button>
                    </div>
                </div>

                <div class="modal-section">
                    <h3>About</h3>
                    <p><strong>VAW Desk Assessment Tool</strong></p>
                    <p>Municipality of Baggao, Cagayan</p>
                    <p style="font-size: 13px; color: #80868b; margin-top: 8px;">Version 2.0 ‚Ä¢ 2025</p>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="importFileInput" accept=".json" multiple style="display: none;" onchange="handleFileImport(event)">

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üèõÔ∏è Municipality of Baggao</h1>
            <p>VAW Desk Functionality Assessment 2025</p>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div class="progress-text" id="progressText">Step 0 of 7</div>

        <!-- Dashboard (Initial Screen) -->
        <div class="dashboard" id="dashboard">
            <div class="dashboard-header">
                <h2>Assessment Dashboard</h2>
                <p id="raterInfo" style="font-weight: 600; color: #1a73e8;">Loading...</p>
            </div>

            <div class="progress-summary">
                <div class="label">Overall Progress</div>
                <div class="big-number" id="overallProgress">0/48</div>
                <div class="label">Barangays Assessed</div>
            </div>

            <div class="form-group">
                <label for="dashboardBarangay">Select Barangay to Assess:</label>
                <select id="dashboardBarangay">
                    <option value="">-- Choose Barangay --</option>
                    <option value="Adaoag">Adaoag</option>
                    <option value="Agaman (Proper)">Agaman (Proper)</option>
                    <option value="Agaman Norte">Agaman Norte</option>
                    <option value="Agaman Sur">Agaman Sur</option>
                    <option value="Alba">Alba</option>
                    <option value="Annayatan">Annayatan</option>
                    <option value="Asassi">Asassi</option>
                    <option value="Asinga-Via">Asinga-Via</option>
                    <option value="Awallan">Awallan</option>
                    <option value="Bacagan">Bacagan</option>
                    <option value="Bagunot">Bagunot</option>
                    <option value="Barsat East">Barsat East</option>
                    <option value="Barsat West">Barsat West</option>
                    <option value="Bitag Grande">Bitag Grande</option>
                    <option value="Bitag Peque√±o">Bitag Peque√±o</option>
                    <option value="Bunugan">Bunugan</option>
                    <option value="C. Verzosa (Valley Cove)">C. Verzosa (Valley Cove)</option>
                    <option value="Canagatan">Canagatan</option>
                    <option value="Carupian">Carupian</option>
                    <option value="Catugay">Catugay</option>
                    <option value="Dabbac Grande">Dabbac Grande</option>
                    <option value="Dalin">Dalin</option>
                    <option value="Dalla">Dalla</option>
                    <option value="Hacienda Intal">Hacienda Intal</option>
                    <option value="Ibulo">Ibulo</option>
                    <option value="Immurung">Immurung</option>
                    <option value="J. Pallagao">J. Pallagao</option>
                    <option value="Lasilat">Lasilat</option>
                    <option value="Mabini">Mabini</option>
                    <option value="Masical">Masical</option>
                    <option value="Mocag">Mocag</option>
                    <option value="Nangalinan">Nangalinan</option>
                    <option value="Poblacion (Centro)">Poblacion (Centro)</option>
                    <option value="Remus">Remus</option>
                    <option value="San Antonio">San Antonio</option>
                    <option value="San Francisco">San Francisco</option>
                    <option value="San Isidro">San Isidro</option>
                    <option value="San Jose">San Jose</option>
                    <option value="San Miguel">San Miguel</option>
                    <option value="San Vicente">San Vicente</option>
                    <option value="Santa Margarita">Santa Margarita</option>
                    <option value="Santor">Santor</option>
                    <option value="Taguing">Taguing</option>
                    <option value="Taguntungan">Taguntungan</option>
                    <option value="Tallang">Tallang</option>
                    <option value="Taytay">Taytay</option>
                    <option value="Temblique">Temblique</option>
                    <option value="Tungel">Tungel</option>
                </select>
            </div>

            <button class="btn btn-next" onclick="startAssessment()" id="startBtn" disabled style="margin-bottom: 32px;">
                Start Assessment ‚Üí
            </button>

            <div class="barangay-grid" id="barangayGrid"></div>

            <div class="submit-section" id="submitSection" style="display: none;">
                <h3>üéâ All Assessments Complete!</h3>
                <p>Ready to submit your data to the coordinator.</p>
                <button class="btn btn-submit" onclick="submitAllData()">
                    üìß Submit All to Coordinator
                </button>
            </div>
        </div>

        <!-- Assessment Form (Hidden Initially) -->
        <div class="content hidden" id="assessmentForm">
            <!-- Step 0: Barangay Selection -->
            <div class="step active" id="step0">
                <div class="section-title">Select Barangay</div>
                
                <div class="form-group">
                    <label for="barangaySelect">Barangay Name:</label>
                    <select id="barangaySelect" onchange="updateBarangaySelection()">
                        <option value="">-- Select Barangay --</option>
                        <option value="Adaoag">Adaoag</option>
                        <option value="Agaman (Proper)">Agaman (Proper)</option>
                        <option value="Agaman Norte">Agaman Norte</option>
                        <option value="Agaman Sur">Agaman Sur</option>
                        <option value="Alba">Alba</option>
                        <option value="Annayatan">Annayatan</option>
                        <option value="Asassi">Asassi</option>
                        <option value="Asinga-Via">Asinga-Via</option>
                        <option value="Awallan">Awallan</option>
                        <option value="Bacagan">Bacagan</option>
                        <option value="Bagunot">Bagunot</option>
                        <option value="Barsat East">Barsat East</option>
                        <option value="Barsat West">Barsat West</option>
                        <option value="Bitag Grande">Bitag Grande</option>
                        <option value="Bitag Peque√±o">Bitag Peque√±o</option>
                        <option value="Bunugan">Bunugan</option>
                        <option value="C. Verzosa (Valley Cove)">C. Verzosa (Valley Cove)</option>
                        <option value="Canagatan">Canagatan</option>
                        <option value="Carupian">Carupian</option>
                        <option value="Catugay">Catugay</option>
                        <option value="Dabbac Grande">Dabbac Grande</option>
                        <option value="Dalin">Dalin</option>
                        <option value="Dalla">Dalla</option>
                        <option value="Hacienda Intal">Hacienda Intal</option>
                        <option value="Ibulo">Ibulo</option>
                        <option value="Immurung">Immurung</option>
                        <option value="J. Pallagao">J. Pallagao</option>
                        <option value="Lasilat">Lasilat</option>
                        <option value="Mabini">Mabini</option>
                        <option value="Masical">Masical</option>
                        <option value="Mocag">Mocag</option>
                        <option value="Nangalinan">Nangalinan</option>
                        <option value="Poblacion (Centro)">Poblacion (Centro)</option>
                        <option value="Remus">Remus</option>
                        <option value="San Antonio">San Antonio</option>
                        <option value="San Francisco">San Francisco</option>
                        <option value="San Isidro">San Isidro</option>
                        <option value="San Jose">San Jose</option>
                        <option value="San Miguel">San Miguel</option>
                        <option value="San Vicente">San Vicente</option>
                        <option value="Santa Margarita">Santa Margarita</option>
                        <option value="Santor">Santor</option>
                        <option value="Taguing">Taguing</option>
                        <option value="Taguntungan">Taguntungan</option>
                        <option value="Tallang">Tallang</option>
                        <option value="Taytay">Taytay</option>
                        <option value="Temblique">Temblique</option>
                        <option value="Tungel">Tungel</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="assessmentDate">Date of Assessment:</label>
                    <input type="date" id="assessmentDate">
                </div>

                <div class="alert alert-info">
                    <strong>üìã Instructions:</strong><br>
                    Select the barangay you are assessing and the date. All answers will be saved automatically as you progress through the form.
                </div>

                <div class="button-group">
                    <button class="btn btn-previous" onclick="backToDashboard()">‚Üê Dashboard</button>
                    <button class="btn btn-next" onclick="nextStep()" id="step0Next" disabled>Next ‚Üí</button>
                </div>
            </div>

            <!-- Step 1: Establishment Part 1 (1.a) -->
            <div class="step" id="step1">
                <div class="section-title">1. Establishment</div>
                
                <div class="barangay-info">
                    <strong>Barangay:</strong> <span id="barangay1"></span><br>
                    <strong>Section Score:</strong> <span id="score1" style="font-size: 20px; color: #28A745;">0/20</span>
                </div>

                <div class="form-group">
                    <label>1.a. The Barangay VAW Desk is established through: (5%)</label>
                    <div class="radio-group">
                        <div class="radio-option" onclick="selectRadio('q1a', 'ordinance', 5)">
                            <input type="radio" name="q1a" value="ordinance" id="q1a_ordinance">
                            <label for="q1a_ordinance">Barangay Ordinance</label>
                            <span class="point-badge">5%</span>
                        </div>
                        <div class="radio-option" onclick="selectRadio('q1a', 'eo', 5)">
                            <input type="radio" name="q1a" value="eo" id="q1a_eo">
                            <label for="q1a_eo">Executive Order</label>
                            <span class="point-badge">5%</span>
                        </div>
                        <div class="radio-option" onclick="selectRadio('q1a', 'both', 5)">
                            <input type="radio" name="q1a" value="both" id="q1a_both">
                            <label for="q1a_both">Both Ordinance & EO</label>
                            <span class="point-badge">5%</span>
                        </div>
                        <div class="radio-option" onclick="selectRadio('q1a', 'none', 0)">
                            <input type="radio" name="q1a" value="none" id="q1a_none">
                            <label for="q1a_none">None</label>
                            <span class="point-badge">0%</span>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-previous" onclick="previousStep()">‚Üê Previous</button>
                    <button class="btn btn-next" onclick="nextStep()">Next ‚Üí</button>
                </div>
            </div>

            <!-- Step 2: Establishment Part 2 (1.b, 1.c, 1.d) -->
            <div class="step" id="step2">
                <div class="section-title">1. Establishment (continued)</div>
                
                <div class="barangay-info">
                    <strong>Barangay:</strong> <span id="barangay2"></span><br>
                    <strong>Section Score:</strong> <span id="score2" style="font-size: 20px; color: #28A745;">0/20</span>
                </div>

                <div class="form-group">
                    <label>1.b. Barangay VAW Desk Person has attended: (5% total)</label>
                    <div class="checkbox-group">
                        <div class="checkbox-option" onclick="toggleCheckbox('q1b_antivaw')">
                            <input type="checkbox" id="q1b_antivaw" onchange="calculateScores()">
                            <label for="q1b_antivaw">Orientation on Anti-VAW Laws (RA 9262, 9208, etc.)</label>
                            <span class="point-badge">2%</span>
                        </div>
                        <div class="checkbox-option" onclick="toggleCheckbox('q1b_gender')">
                            <input type="checkbox" id="q1b_gender" onchange="calculateScores()">
                            <label for="q1b_gender">Gender-Sensitivity Training</label>
                            <span class="point-badge">2%</span>
                        </div>
                        <div class="checkbox-option" onclick="toggleCheckbox('q1b_crisis')">
                            <input type="checkbox" id="q1b_crisis" onchange="calculateScores()">
                            <label for="q1b_crisis">Basic Crisis Intervention</label>
                            <span class="point-badge">1%</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>1.c. VAW Desk Location: (5%)</label>
                    <div class="checkbox-group">
                        <div class="checkbox-option" onclick="toggleCheckbox('q1c_location')">
                            <input type="checkbox" id="q1c_location" onchange="calculateScores()">
                            <label for="q1c_location">Located within the barangay hall or near Punong Barangay office</label>
                            <span class="point-badge">5%</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>1.d. Interview Room: (5%)</label>
                    <div class="checkbox-group">
                        <div class="checkbox-option" onclick="toggleCheckbox('q1d_room')">
                            <input type="checkbox" id="q1d_room" onchange="calculateScores()">
                            <label for="q1d_room">Has a separate room or enclosed area for private interviews</label>
                            <span class="point-badge">5%</span>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-previous" onclick="previousStep()">‚Üê Previous</button>
                    <button class="btn btn-next" onclick="nextStep()">Next ‚Üí</button>
                </div>
            </div>

            <!-- Step 3: Resources - Furniture & Equipment -->
            <div class="step" id="step3">
                <div class="section-title">2. Resources</div>
                
                <div class="barangay-info">
                    <strong>Barangay:</strong> <span id="barangay3"></span><br>
                    <strong>Section Score:</strong> <span id="score3" style="font-size: 20px; color: #28A745;">0/20</span>
                </div>

                <div class="form-group">
                    <label>2.a. Furniture and Vehicle: (4% total)</label>
                    <div class="checkbox-group">
                        <div class="checkbox-option" onclick="toggleCheckbox('q2a_table')">
                            <input type="checkbox" id="q2a_table" onchange="calculateScores()">
                            <label for="q2a_table">Table and chair</label>
                            <span class="point-badge">1%</span>
                        </div>
                        <div class="checkbox-option" onclick="toggleCheckbox('q2a_cabinet')">
                            <input type="checkbox" id="q2a_cabinet" onchange="calculateScores()">
                            <label for="q2a_cabinet">Filing cabinet/storage area</label>
                            <span class="point-badge">1%</span>
                        </div>
                        <div class="checkbox-option" onclick="toggleCheckbox('q2a_bed')">
                            <input type="checkbox" id="q2a_bed" onchange="calculateScores()">
                            <label for="q2a_bed">Sofa bed, folding bed, or mat</label>
                            <span class="point-badge">1%</span>
                        </div>
                        <div class="checkbox-option" onclick="toggleCheckbox('q2a_vehicle')">
                            <input type="checkbox" id="q2a_vehicle" onchange="calculateScores()">
                            <label for="q2a_vehicle">Availability of vehicle/transportation for victim-survivors</label>
                            <span class="point-badge">1%</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>2.b. Equipment and Supplies: (6% total)</label>
                    <div class="checkbox-group">
                        <div class="checkbox-option" onclick="toggleCheckbox('q2b_phone')">
                            <input type="checkbox" id="q2b_phone" onchange="calculateScores()">
                            <label for="q2b_phone">Landline or mobile phone</label>
                            <span class="point-badge">2%</span>
                        </div>
                        <div class="checkbox-option" onclick="toggleCheckbox('q2b_computer')">
                            <input type="checkbox" id="q2b_computer" onchange="calculateScores()">
                            <label for="q2b_computer">Computer or typewriter for logging/monitoring</label>
                            <span class="point-badge">1%</span>
                        </div>
                        <div class="checkbox-option" onclick="toggleCheckbox('q2b_camera')">
                            <input type="checkbox" id="q2b_camera" onchange="calculateScores()">
                            <label for="q2b_camera">Camera for documenting physical evidence</label>
                            <span class="point-badge">1%</span>
                        </div>
                        <div class="checkbox-option" onclick="toggleCheckbox('q2b_recorder')">
                            <input type="checkbox" id="q2b_recorder" onchange="calculateScores()">
                            <label for="q2b_recorder">Tape or voice recorder for case narratives</label>
                            <span class="point-badge">1%</span>
                        </div>
                        <div class="checkbox-option" onclick="toggleCheckbox('q2b_firstaid')">
                            <input type="checkbox" id="q2b_firstaid" onchange="calculateScores()">
                            <label for="q2b_firstaid">First aid kit and other medicines</label>
                            <span class="point-badge">1%</span>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-previous" onclick="previousStep()">‚Üê Previous</button>
                    <button class="btn btn-next" onclick="nextStep()">Next ‚Üí</button>
                </div>
            </div>

            <!-- Step 4: Resources - Monitoring Tools & References -->
            <div class="step" id="step4">
                <div class="section-title">2. Resources (continued)</div>
                
                <div class="barangay-info">
                    <strong>Barangay:</strong> <span id="barangay4"></span><br>
                    <strong>Section Score:</strong> <span id="score4" style="font-size: 20px; color: #28A745;">0/20</span>
                </div>

                <div class="form-group">
                    <label>2.c. Monitoring Tools: (5% total)</label>
                    <div class="checkbox-group">
                        <div style="margin-bottom: 15px; font-weight: 600; color: #333;">Logbooks:</div>
                        <div class="checkbox-option" onclick="toggleCheckbox('q2c_logbook1')">
                            <input type="checkbox" id="q2c_logbook1" onchange="calculateScores()">
                            <label for="q2c_logbook1">Logbook 1: for RA 9262 cases</label>
                            <span class="point-badge">1.5%</span>
                        </div>
                        <div class="checkbox-option" onclick="toggleCheckbox('q2c_logbook2')">
                            <input type="checkbox" id="q2c_logbook2" onchange="calculateScores()">
                            <label for="q2c_logbook2">Logbook 2: for other VAW related cases</label>
                            <span class="point-badge">1.5%</span>
                        </div>
                        
                        <div style="margin: 15px 0; font-weight: 600; color: #333;">Forms:</div>
                        <div class="checkbox-option" onclick="toggleCheckbox('q2c_intake')">
                            <input type="checkbox" id="q2c_intake" onchange="calculateScores()">
                            <label for="q2c_intake">VAW Docs Intake Form</label>
                            <span class="point-badge">0.5%</span>
                        </div>
                        <div class="checkbox-option" onclick="toggleCheckbox('q2c_referral')">
                            <input type="checkbox" id="q2c_referral" onchange="calculateScores()">
                            <label for="q2c_referral">Referral Form</label>
                            <span class="point-badge">0.5%</span>
                        </div>
                        <div class="checkbox-option" onclick="toggleCheckbox('q2c_feedback')">
                            <input type="checkbox" id="q2c_feedback" onchange="calculateScores()">
                            <label for="q2c_feedback">Feedback Form</label>
                            <span class="point-badge">0.5%</span>
                        </div>
                        <div class="checkbox-option" onclick="toggleCheckbox('q2c_bpo')">
                            <input type="checkbox" id="q2c_bpo" onchange="calculateScores()">
                            <label for="q2c_bpo">BPO Application Form</label>
                            <span class="point-badge">0.5%</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>2.d. References: (5% total)</label>
                    <div class="checkbox-group">
                        <div class="checkbox-option" onclick="toggleCheckbox('q2d_directory')">
                            <input type="checkbox" id="q2d_directory" onchange="calculateScores()">
                            <label for="q2d_directory">Directory of service providers</label>
                            <span class="point-badge">2%</span>
                        </div>
                        <div class="checkbox-option" onclick="toggleCheckbox('q2d_handbook')">
                            <input type="checkbox" id="q2d_handbook" onchange="calculateScores()">
                            <label for="q2d_handbook">VAW Desk Handbook</label>
                            <span class="point-badge">1%</span>
                        </div>
                        <div class="checkbox-option" onclick="toggleCheckbox('q2d_books')">
                            <input type="checkbox" id="q2d_books" onchange="calculateScores()">
                            <label for="q2d_books">VAW-related reference books, brochures</label>
                            <span class="point-badge">1%</span>
                        </div>
                        <div class="checkbox-option" onclick="toggleCheckbox('q2d_bpo_flow')">
                            <input type="checkbox" id="q2d_bpo_flow" onchange="calculateScores()">
                            <label for="q2d_bpo_flow">Flowchart on BPO issuance</label>
                            <span class="point-badge">0.5%</span>
                        </div>
                        <div class="checkbox-option" onclick="toggleCheckbox('q2d_vaw_flow')">
                            <input type="checkbox" id="q2d_vaw_flow" onchange="calculateScores()">
                            <label for="q2d_vaw_flow">Flowchart on Handling of VAW Cases</label>
                            <span class="point-badge">0.5%</span>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-previous" onclick="previousStep()">‚Üê Previous</button>
                    <button class="btn btn-next" onclick="nextStep()">Next ‚Üí</button>
                </div>
            </div>

            <!-- Step 5: Policies, Plans, and Budget -->
            <div class="step" id="step5">
                <div class="section-title">3. Policies, Plans, and Budget</div>
                
                <div class="barangay-info">
                    <strong>Barangay:</strong> <span id="barangay5"></span><br>
                    <strong>Section Score:</strong> <span id="score5" style="font-size: 20px; color: #28A745;">0/20</span>
                </div>

                <div class="form-group">
                    <label>3.a. Annual Investment Program (AIP): (5%)</label>
                    <div class="checkbox-group">
                        <div class="checkbox-option" onclick="toggleCheckbox('q3a_aip')">
                            <input type="checkbox" id="q3a_aip" onchange="calculateScores()">
                            <label for="q3a_aip">Annual Investment Program (AIP) reflecting the approved Barangay GAD Plan and Budget</label>
                            <span class="point-badge">5%</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>3.b. Certificate of Review: (5%)</label>
                    <div class="checkbox-group">
                        <div class="checkbox-option" onclick="toggleCheckbox('q3b_cert')">
                            <input type="checkbox" id="q3b_cert" onchange="calculateScores()">
                            <label for="q3b_cert">Certificate of Review and endorsement of the 2024 GAD Plan and Budget</label>
                            <span class="point-badge">5%</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>3.c. GAD Plan Programs: (5%)</label>
                    <div class="checkbox-group">
                        <div class="checkbox-option" onclick="toggleCheckbox('q3c_gad')">
                            <input type="checkbox" id="q3c_gad" onchange="calculateScores()">
                            <label for="q3c_gad">Gender-responsive program and activities to address gender-based violence is indicated in the approved Barangay GAD Plan and Budget</label>
                            <span class="point-badge">5%</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>3.d. BDP Programs: (5%)</label>
                    <div class="checkbox-group">
                        <div class="checkbox-option" onclick="toggleCheckbox('q3d_bdp')">
                            <input type="checkbox" id="q3d_bdp" onchange="calculateScores()">
                            <label for="q3d_bdp">Gender-responsive program and activities to address gender-based violence is integrated in the Barangay Development Plan (BDP)</label>
                            <span class="point-badge">5%</span>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-previous" onclick="previousStep()">‚Üê Previous</button>
                    <button class="btn btn-next" onclick="nextStep()">Next ‚Üí</button>
                </div>
            </div>

            <!-- Step 6: Accomplishments -->
            <div class="step" id="step6">
                <div class="section-title">4. Accomplishments</div>
                
                <div class="barangay-info">
                    <strong>Barangay:</strong> <span id="barangay6"></span><br>
                    <strong>Section Score:</strong> <span id="score6" style="font-size: 20px; color: #28A745;">0/40</span>
                </div>

                <div class="form-group">
                    <label>4.a. Annual Accomplishment Report: (10%)</label>
                    <div class="checkbox-group">
                        <div class="checkbox-option" onclick="toggleCheckbox('q4a_annual')">
                            <input type="checkbox" id="q4a_annual" onchange="calculateScores()">
                            <label for="q4a_annual">Annual Accomplishment Report based on the approved Barangay GAD Plan and Budget</label>
                            <span class="point-badge">10%</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>4.b. Quarterly Accomplishment Reports: (10%)</label>
                    <div class="radio-group">
                        <div class="radio-option" onclick="selectRadio('q4b', '4', 10)">
                            <input type="radio" name="q4b" value="4" id="q4b_4">
                            <label for="q4b_4">4 quarterly accomplishment reports submitted (with received stamp)</label>
                            <span class="point-badge">10%</span>
                        </div>
                        <div class="radio-option" onclick="selectRadio('q4b', '3', 7.5)">
                            <input type="radio" name="q4b" value="3" id="q4b_3">
                            <label for="q4b_3">3 quarterly accomplishment reports</label>
                            <span class="point-badge">7.5%</span>
                        </div>
                        <div class="radio-option" onclick="selectRadio('q4b', '2', 5)">
                            <input type="radio" name="q4b" value="2" id="q4b_2">
                            <label for="q4b_2">2 quarterly accomplishment reports</label>
                            <span class="point-badge">5%</span>
                        </div>
                        <div class="radio-option" onclick="selectRadio('q4b', '1', 2.5)">
                            <input type="radio" name="q4b" value="1" id="q4b_1">
                            <label for="q4b_1">1 quarterly accomplishment report</label>
                            <span class="point-badge">2.5%</span>
                        </div>
                        <div class="radio-option" onclick="selectRadio('q4b', '0', 0)">
                            <input type="radio" name="q4b" value="0" id="q4b_0">
                            <label for="q4b_0">None</label>
                            <span class="point-badge">0%</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>4.c. Updated Database/Records: (10%)</label>
                    <div class="checkbox-group">
                        <div class="checkbox-option" onclick="toggleCheckbox('q4c_database')">
                            <input type="checkbox" id="q4c_database" onchange="calculateScores()">
                            <label for="q4c_database">Updated database/records of all VAW cases reported in the barangay</label>
                            <span class="point-badge">10%</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>4.d. State of Barangay Address (SOBA) Inclusion: (10%)</label>
                    <div class="radio-group">
                        <div class="radio-option" onclick="selectRadio('q4d', '2', 10)">
                            <input type="radio" name="q4d" value="2" id="q4d_2">
                            <label for="q4d_2">Accomplishments of VAW Desk included in two (2) SOBA</label>
                            <span class="point-badge">10%</span>
                        </div>
                        <div class="radio-option" onclick="selectRadio('q4d', '1', 5)">
                            <input type="radio" name="q4d" value="1" id="q4d_1">
                            <label for="q4d_1">Accomplishments of VAW Desk included in one (1) SOBA</label>
                            <span class="point-badge">5%</span>
                        </div>
                        <div class="radio-option" onclick="selectRadio('q4d', '0', 0)">
                            <input type="radio" name="q4d" value="0" id="q4d_0">
                            <label for="q4d_0">Accomplishments of VAW Desk not included in SOBA</label>
                            <span class="point-badge">0%</span>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-previous" onclick="previousStep()">‚Üê Previous</button>
                    <button class="btn btn-next" onclick="nextStep()">Review Summary ‚Üí</button>
                </div>
            </div>

            <!-- Step 7: Summary -->
            <div class="step" id="step7">
                <div class="section-title">Assessment Summary</div>
                
                <div class="alert alert-success">
                    <strong>‚úÖ Assessment Complete!</strong><br>
                    Review your answers below before saving.
                </div>

                <div class="score-display">
                    <div class="label">FINAL SCORE</div>
                    <div class="big-score" id="finalScore">0</div>
                    <div class="label">out of 100 points</div>
                </div>

                <div class="barangay-info">
                    <strong>Barangay:</strong> <span id="barangay7"></span><br>
                    <strong>Date Assessed:</strong> <span id="date7"></span><br>
                    <strong>Assessed By:</strong> <span id="assessedBy7">Loading...</span>
                </div>

                <div class="summary-section">
                    <h3>Section Breakdown</h3>
                    <div class="summary-item">
                        <span>1. Establishment</span>
                        <strong><span id="summaryScore1">0</span>/20</strong>
                    </div>
                    <div class="summary-item">
                        <span>2. Resources</span>
                        <strong><span id="summaryScore2">0</span>/20</strong>
                    </div>
                    <div class="summary-item">
                        <span>3. Policies, Plans, and Budget</span>
                        <strong><span id="summaryScore3">0</span>/20</strong>
                    </div>
                    <div class="summary-item">
                        <span>4. Accomplishments</span>
                        <strong><span id="summaryScore4">0</span>/40</strong>
                    </div>
                </div>

                <div class="button-group" id="step7ButtonGroup">
                    <button class="btn btn-previous" onclick="previousStep()">‚Üê Edit Answers</button>
                    <button class="btn btn-submit" onclick="saveAssessment()" id="saveAssessmentBtn">üíæ Save Assessment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Developer Footer -->
    <div class="developer-footer">
        <div class="footer-badge">
            <div class="footer-icon">üíª</div>
            <span>Developed by Richmond Rosete</span>
        </div>
    </div>

    <!-- UNLOCK ASSESSMENT MODAL -->
    <div class="unlock-modal" id="unlockModal">
        <div class="unlock-modal-content">
            <div class="unlock-modal-header">
                <h2>üîì Unlock Assessment</h2>
                <p>Enter your PIN to unlock and edit this assessment</p>
            </div>

            <div class="unlock-barangay-name" id="unlockBarangayName">
                <!-- Barangay name will be inserted here -->
            </div>

            <div class="unlock-pin-boxes">
                <input type="text" class="unlock-pin-box" id="unlockPin1" maxlength="1" inputmode="numeric" autocomplete="off">
                <input type="text" class="unlock-pin-box" id="unlockPin2" maxlength="1" inputmode="numeric" autocomplete="off">
                <input type="text" class="unlock-pin-box" id="unlockPin3" maxlength="1" inputmode="numeric" autocomplete="off">
                <input type="text" class="unlock-pin-box" id="unlockPin4" maxlength="1" inputmode="numeric" autocomplete="off">
            </div>

            <div class="unlock-modal-buttons">
                <button class="unlock-modal-btn cancel" onclick="closeUnlockModal()">Cancel</button>
                <button class="unlock-modal-btn verify" onclick="verifyUnlockPin()">Unlock</button>
            </div>

            <div class="unlock-error" id="unlockError">
                ‚ùå Invalid PIN. Please try again.
            </div>
        </div>
    </div>

    <!-- FACTORY RESET MODAL -->
    <div class="unlock-modal" id="factoryResetModal">
        <div class="unlock-modal-content" style="border: 3px solid #FF6B35;">
            <div class="unlock-modal-header">
                <h2>üîß Factory Reset</h2>
                <p style="color: #DC2626; font-weight: 600;">‚ö†Ô∏è ADMIN ACCESS REQUIRED</p>
            </div>

            <div style="background: #FFF3CD; border: 2px solid #FFC107; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 0; font-size: 14px; color: #856404; font-weight: 600;">
                    ‚ö†Ô∏è WARNING: This will delete ALL data and files!
                </p>
                <p style="margin: 8px 0 0 0; font-size: 13px; color: #856404;">
                    ‚Ä¢ All assessments<br>
                    ‚Ä¢ All JSON files<br>
                    ‚Ä¢ All archive files<br>
                    ‚Ä¢ All progress data
                </p>
            </div>

            <div style="text-align: center; margin-bottom: 20px;">
                <p style="font-size: 14px; color: #666; margin-bottom: 12px;">Enter ADMIN PIN to proceed:</p>
            </div>

            <div class="unlock-pin-boxes">
                <input type="text" class="unlock-pin-box" id="resetPin1" maxlength="1" inputmode="numeric" autocomplete="off">
                <input type="text" class="unlock-pin-box" id="resetPin2" maxlength="1" inputmode="numeric" autocomplete="off">
                <input type="text" class="unlock-pin-box" id="resetPin3" maxlength="1" inputmode="numeric" autocomplete="off">
                <input type="text" class="unlock-pin-box" id="resetPin4" maxlength="1" inputmode="numeric" autocomplete="off">
            </div>

            <div class="unlock-modal-buttons">
                <button class="unlock-modal-btn cancel" onclick="closeFactoryResetModal()">Cancel</button>
                <button class="unlock-modal-btn verify" style="background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%);" onclick="verifyResetPin()">‚ö†Ô∏è Factory Reset</button>
            </div>

            <div class="unlock-error" id="resetError">
                ‚ùå Invalid ADMIN PIN. Access denied.
            </div>

            <div style="text-align: center; margin-top: 16px;">
                <p style="font-size: 11px; color: #999;">For demo/testing purposes only</p>
            </div>
        </div>
    </div>

    <!-- EmailJS Library (Latest Version) -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <script>
        // ============================================
        // LOGIN AUTHENTICATION CHECK
        // ============================================
        let currentUser = null;

        (function checkAuthentication() {
            const session = localStorage.getItem('vaw_login_session');

            if (!session) {
                // Not logged in - redirect to login page
                window.location.href = 'START_HERE.html';
                return;
            }

            try {
                currentUser = JSON.parse(session);

                if (!currentUser.isAuthenticated) {
                    // Invalid session - redirect to login
                    window.location.href = 'START_HERE.html';
                    return;
                }

                // Update UI with logged-in user info
                updateUserInterface(currentUser);

            } catch (error) {
                console.error('Session error:', error);
                window.location.href = 'START_HERE.html';
            }
        })();

        /**
         * Update UI with logged-in user information
         */
        function updateUserInterface(user) {
            // Update navigation title
            const navTitle = document.getElementById('navTitle');
            if (navTitle && window.innerWidth > 600) {
                navTitle.textContent = `${user.name}`;
            }

            // Update dashboard rater info
            const raterInfo = document.getElementById('raterInfo');
            if (raterInfo) {
                raterInfo.textContent = `${user.name} - ${user.position}`;
            }

            // Update Step 7 assessor name
            const assessedBy7 = document.getElementById('assessedBy7');
            if (assessedBy7) {
                assessedBy7.textContent = user.name;
            }

            // Update menu modal
            const userNameElem = document.getElementById('loggedInUserName');
            const userPositionElem = document.getElementById('loggedInUserPosition');

            if (userNameElem) userNameElem.textContent = user.name;
            if (userPositionElem) userPositionElem.textContent = `${user.position} ‚Ä¢ PIN: ${user.pin}`;

            console.log(`%c‚úÖ Logged in as: ${user.name}`, 'color: #1a73e8; font-weight: bold;');
        }

        /**
         * Get current assessor name
         */
        function getCurrentAssessorName() {
            return currentUser ? currentUser.name : 'Unknown Assessor';
        }

        /**
         * Handle logout
         */
        function handleLogout() {
            const confirmed = confirm(
                `üö™ LOGOUT\n\n` +
                `Are you sure you want to logout?\n\n` +
                `Make sure all your work is saved before logging out.`
            );

            if (confirmed) {
                // Clear session
                localStorage.removeItem('vaw_login_session');

                // Show message
                alert('‚úÖ Logged out successfully!\n\nRedirecting to login page...');

                // Redirect to login
                window.location.href = 'START_HERE.html';
            }
        }

        // Initialize EmailJS with new SDK
        (function() {
            emailjs.init({
                publicKey: "zquhILJk68y45UqRw"
            });
        })();

        // Barangays array (ALL 48 OFFICIAL BARANGAYS - CORRECTED)
        const barangays = [
            'Adaoag', 'Agaman (Proper)', 'Agaman Norte', 'Agaman Sur', 'Alba', 'Annayatan',
            'Asassi', 'Asinga-Via', 'Awallan', 'Bacagan', 'Bagunot', 'Barsat East',
            'Barsat West', 'Bitag Grande', 'Bitag Peque√±o', 'Bunugan', 'C. Verzosa (Valley Cove)',
            'Canagatan', 'Carupian', 'Catugay', 'Dabbac Grande', 'Dalin', 'Dalla',
            'Hacienda Intal', 'Ibulo', 'Immurung', 'J. Pallagao', 'Lasilat', 'Mabini',
            'Masical', 'Mocag', 'Nangalinan', 'Poblacion (Centro)', 'Remus', 'San Antonio',
            'San Francisco', 'San Isidro', 'San Jose', 'San Miguel', 'San Vicente',
            'Santa Margarita', 'Santor', 'Taguing', 'Taguntungan', 'Tallang', 'Taytay',
            'Temblique', 'Tungel'
        ];

        // Application state
        let currentStep = 0;
        let currentBarangay = '';
        let assessmentData = {};
        let allAssessments = loadFromLocalStorage() || {};
        let lastSelectedRadio = {}; // Track last selected radio for each group

        // NOTE: fixDataConsistency() is called in updateDashboard() during initialization
        // This ensures all completed assessments are properly locked

        // Initialize - Multiple methods for WebView compatibility
        let initAttempts = 0;
        let initInterval = null;

        async function initializeApp() {
            initAttempts++;
            console.log(`Initialization attempt #${initAttempts}`);

            try {
                // Barangays are hardcoded in HTML - just initialize app state
                setTodayDate();
                updateDashboard();

                // Restore saved directory handle from previous session
                await initializeDirectoryHandle();

                console.log('App initialized successfully!');

                // Stop retrying
                if (initInterval) {
                    clearInterval(initInterval);
                    initInterval = null;
                }

                return true;
            } catch (error) {
                console.error('Initialization error:', error);
                return false;
            }
        }

        // Try multiple initialization methods for Android WebView compatibility
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded fired');
            initializeApp();
        });

        window.addEventListener('load', function() {
            console.log('Window load fired');
            initializeApp();
        });

        // Aggressive retry with interval (for stubborn WebViews)
        setTimeout(function() {
            console.log('Starting aggressive retry interval');
            initInterval = setInterval(function() {
                const success = initializeApp();
                if (success || initAttempts > 10) {
                    clearInterval(initInterval);
                    if (!success) {
                        console.error('Failed to initialize after 10 attempts');
                        alert('‚ö†Ô∏è INITIALIZATION ERROR\n\nBarangay dropdowns failed to load.\n\nPlease close and reopen the app.');
                    }
                }
            }, 300);
        }, 100);

        function populateBarangayDropdowns() {
            // Barangays are now hardcoded in HTML for better WebView compatibility
            // This function is kept for compatibility but does nothing
            console.log('Barangays are hardcoded in HTML - no dynamic population needed');
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('assessmentDate').value = today;
        }

        /**
         * FIX DATA CONSISTENCY - Ensure all completed assessments are locked
         * This fixes old data that might not have the locked flag
         */
        function fixDataConsistency(showAlert = false) {
            let fixedCount = 0;
            const fixedBarangays = [];

            Object.keys(allAssessments).forEach(barangay => {
                const assessment = allAssessments[barangay];

                // If assessment is completed but NOT locked, fix it
                if (assessment.status === 'completed' && assessment.locked !== true) {
                    console.log(`‚ö†Ô∏è Fixing unlocked completed assessment: ${barangay}`);
                    assessment.locked = true;

                    // Add completion date if missing
                    if (!assessment.completedDate) {
                        assessment.completedDate = new Date().toISOString();
                    }

                    fixedCount++;
                    fixedBarangays.push(barangay);
                }
            });

            if (fixedCount > 0) {
                console.log(`‚úÖ Fixed ${fixedCount} assessments - set locked: true`);
                saveToLocalStorage();

                // Show alert if requested (for user-initiated actions)
                if (showAlert) {
                    const barangayList = fixedBarangays.slice(0, 10).join(', ');
                    const more = fixedCount > 10 ? `\n...and ${fixedCount - 10} more` : '';
                    alert(`üîß DATA AUTO-FIXED\n\n${fixedCount} completed assessment(s) were missing lock flags.\n\nFixed barangays:\n${barangayList}${more}\n\n‚úÖ All completed assessments are now properly locked!`);
                }
            }

            return fixedCount;
        }

        function updateDashboard() {
            // Fix any data inconsistencies first
            fixDataConsistency();

            const completed = Object.keys(allAssessments).filter(b => allAssessments[b].status === 'completed').length;
            document.getElementById('overallProgress').textContent = `${completed}/48`;

            // Show submit button if all complete
            if (completed === 48) {
                document.getElementById('submitSection').style.display = 'block';
            }

            // Populate grid (simplified for now)
            const grid = document.getElementById('barangayGrid');
            grid.innerHTML = '';
            barangays.forEach(b => {
                const card = document.createElement('div');
                card.className = 'barangay-card';
                const data = allAssessments[b];
                if (data && data.status === 'completed') {
                    card.classList.add('completed');
                    const lockIcon = data.locked ? 'üîí ' : '';
                    const isTouchDevice = 'ontouchstart' in window;
                    const lockStatus = data.locked
                        ? (isTouchDevice ? ' (Locked - Hold to unlock)' : ' (Locked - Double-click to unlock)')
                        : '';
                    const editedBadge = data.wasEdited ? '<span class="edited-badge">EDITED</span>' : '';

                    card.innerHTML = `
                        <div class="name">${lockIcon}${b}${editedBadge}</div>
                        <div class="score">${data.totalScore.toFixed(1)}%</div>
                        <div class="status">‚úì Complete${lockStatus}</div>
                    `;

                    // Initialize long-press detection for locked assessments
                    if (data.locked) {
                        initLongPress(card, b);
                        card.style.cursor = 'pointer';
                        // Detect if touch device for better instructions
                        const isTouchDevice = 'ontouchstart' in window;
                        card.title = isTouchDevice
                            ? 'Hold for 3 seconds to unlock'
                            : 'Double-click or hold for 3 seconds to unlock';
                        // Don't add onclick for locked cards - it interferes with long-press
                    } else {
                        // Add click handler only for unlocked completed cards
                        card.onclick = () => {
                            document.getElementById('dashboardBarangay').value = b;
                            document.getElementById('startBtn').disabled = false;
                        };
                    }
                } else {
                    card.innerHTML = `
                        <div class="name">${b}</div>
                        <div class="score">--</div>
                        <div class="status">Not started</div>
                    `;
                    // Add click handler for not started cards
                    card.onclick = () => {
                        document.getElementById('dashboardBarangay').value = b;
                        document.getElementById('startBtn').disabled = false;
                    };
                }
                grid.appendChild(card);
            });
        }

        function startAssessment() {
            const selected = document.getElementById('dashboardBarangay').value;
            if (!selected) {
                alert('Please select a barangay first');
                return;
            }

            currentBarangay = selected;

            // Remove any existing lock banner
            const existingBanner = document.getElementById('lockBanner');
            if (existingBanner) {
                existingBanner.remove();
            }

            // ALWAYS reset form first to clear previous data
            resetAllFormInputs();

            // Enable all inputs first (in case we're switching from a locked assessment)
            enableAllFormInputs();

            // Load existing data if available
            const existingData = allAssessments[currentBarangay];
            if (existingData) {
                loadAssessmentData(existingData);

                // Check if assessment is locked
                if (existingData.locked === true) {
                    // Show locked banner
                    showLockedBanner();

                    // Disable all form inputs
                    disableAllFormInputs();

                    // Show alert
                    alert(`üîí LOCKED ASSESSMENT\n\nThis assessment for ${currentBarangay} has been saved and locked.\n\nYou can view the data but cannot make any changes.\n\nScore: ${existingData.totalScore.toFixed(1)}/100`);
                }
            } else {
                initializeNewAssessment();
            }

            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('assessmentForm').classList.remove('hidden');

            // Set barangay value and enable button AFTER form is visible
            document.getElementById('barangaySelect').value = selected;

            // Only enable Next button if not locked
            if (!existingData || existingData.locked !== true) {
                document.getElementById('step0Next').disabled = false;
            }

            updateBarangayLabels();
            calculateScores();
            updateProgress();
        }

        function showLockedBanner() {
            // Create lock banner
            const banner = document.createElement('div');
            banner.id = 'lockBanner';
            banner.style.cssText = 'background: #ff9800; color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 16px; border-radius: 8px; margin-bottom: 20px;';
            banner.innerHTML = 'üîí THIS ASSESSMENT IS LOCKED - VIEW ONLY MODE (Cannot be modified)';

            // Insert at top of assessment form
            const assessmentForm = document.getElementById('assessmentForm');
            assessmentForm.insertBefore(banner, assessmentForm.firstChild);
        }

        function backToDashboard() {
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('assessmentForm').classList.add('hidden');
            currentStep = 0;
            showStep(0);
            updateDashboard();
        }

        function updateBarangaySelection() {
            const selected = document.getElementById('barangaySelect').value;
            // Only disable if truly empty, otherwise keep enabled
            if (selected) {
                document.getElementById('step0Next').disabled = false;
            }
        }

        function showStep(n) {
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, i) => {
                step.classList.toggle('active', i === n);
            });
            updateProgress();

            // If we're on step 0 and barangay is selected, ensure Next button is enabled
            if (n === 0 && document.getElementById('barangaySelect').value) {
                document.getElementById('step0Next').disabled = false;
            }

            // If we're on step 7 (summary), check if assessment is locked
            if (n === 7) {
                updateStep7Buttons();
            }
        }

        /**
         * Update Step 7 buttons based on lock status
         */
        function updateStep7Buttons() {
            const isLocked = allAssessments[currentBarangay]?.locked === true;
            const buttonGroup = document.getElementById('step7ButtonGroup');

            if (isLocked) {
                // Replace with "Back to Dashboard" button
                buttonGroup.innerHTML = `
                    <button class="btn btn-previous" onclick="previousStep()">‚Üê View Answers</button>
                    <button class="btn btn-submit" onclick="backToDashboard()" style="background: #1a73e8;">
                        üè† Back to Dashboard
                    </button>
                `;
            } else {
                // Show normal Save Assessment button
                buttonGroup.innerHTML = `
                    <button class="btn btn-previous" onclick="previousStep()">‚Üê Edit Answers</button>
                    <button class="btn btn-submit" onclick="saveAssessment()" id="saveAssessmentBtn">üíæ Save Assessment</button>
                `;
            }
        }

        function nextStep() {
            if (currentStep === 0) {
                const barangay = document.getElementById('barangaySelect').value;
                if (!barangay) {
                    alert('Please select a barangay');
                    return;
                }
                currentBarangay = barangay;
                updateBarangayLabels();
                
                if (allAssessments[currentBarangay]) {
                    loadAssessmentData(allAssessments[currentBarangay]);
                } else {
                    initializeNewAssessment();
                }
            }
            
            if (currentStep < 7) {
                currentStep++;
                showStep(currentStep);
                calculateScores();
                saveToLocalStorage();
            }
        }

        function previousStep() {
            if (currentStep > 0) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function updateProgress() {
            const percent = (currentStep / 7) * 100;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = `Step ${currentStep} of 7`;
        }

        function updateBarangayLabels() {
            for (let i = 1; i <= 7; i++) {
                const elem = document.getElementById('barangay' + i);
                if (elem) elem.textContent = currentBarangay;
            }
            const dateElem = document.getElementById('date7');
            if (dateElem) dateElem.textContent = document.getElementById('assessmentDate').value;
        }

        function initializeNewAssessment() {
            assessmentData = {
                barangay: currentBarangay,
                date: document.getElementById('assessmentDate').value,
                assessor: getCurrentAssessorName(),
                status: 'in-progress',
                section1: {},
                section2: {},
                section3: {},
                section4: {},
                totalScore: 0
            };
            // Note: Form reset now happens in startAssessment() before this is called
        }

        function resetAllFormInputs() {
            // Uncheck all radio buttons
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = false;
                radio.parentElement.classList.remove('selected');
            });

            // Uncheck all checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.parentElement.classList.remove('checked');
            });

            // Clear radio tracking
            lastSelectedRadio = {};

            // Reset scores to 0
            calculateScores();
        }

        function disableAllFormInputs() {
            // Disable all radio buttons and checkboxes
            document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
                input.disabled = true;
                input.style.cursor = 'not-allowed';
                input.style.pointerEvents = 'none'; // Completely block clicking

                // Add event listener to prevent any interaction
                input.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                };

                // Also disable the parent label
                if (input.parentElement) {
                    input.parentElement.style.cursor = 'not-allowed';
                    input.parentElement.style.pointerEvents = 'none';
                    input.parentElement.style.opacity = '0.6'; // Make it look disabled
                    input.parentElement.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        return false;
                    };
                }
            });

            // Disable date input
            const dateInput = document.getElementById('assessmentDate');
            if (dateInput) {
                dateInput.disabled = true;
                dateInput.style.pointerEvents = 'none';
            }

            // Disable barangay select
            const barangaySelect = document.getElementById('barangaySelect');
            if (barangaySelect) {
                barangaySelect.disabled = true;
                barangaySelect.style.cursor = 'not-allowed';
                barangaySelect.style.pointerEvents = 'none';
            }

            // Keep navigation buttons ENABLED so user can browse through steps
            // (they just can't edit anything)

            // Hide Save button, replace with View Only message
            const saveBtn = document.querySelector('.btn-submit');
            if (saveBtn) {
                saveBtn.style.display = 'none';
            }

            // Add a "VIEW ONLY" replacement button
            const previousBtn = document.querySelector('.btn-previous');
            if (previousBtn && !document.getElementById('viewOnlyBtn')) {
                const viewOnlyBtn = document.createElement('button');
                viewOnlyBtn.id = 'viewOnlyBtn';
                viewOnlyBtn.className = 'btn';
                viewOnlyBtn.style.cssText = 'background: #6c757d; color: white; cursor: default;';
                viewOnlyBtn.textContent = 'üîí VIEW ONLY - Cannot Save Changes';
                viewOnlyBtn.onclick = () => {
                    alert('This assessment is locked and cannot be modified.\n\nYou can browse through the steps to view the data.');
                };
                previousBtn.parentElement.appendChild(viewOnlyBtn);
            }
        }

        function enableAllFormInputs() {
            // Enable all radio buttons and checkboxes
            document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
                input.disabled = false;
                input.style.cursor = 'pointer';
                input.style.pointerEvents = 'auto'; // Re-enable clicking
                input.onclick = null; // Remove blocking event listener

                // Re-enable the parent label
                if (input.parentElement) {
                    input.parentElement.style.cursor = 'pointer';
                    input.parentElement.style.pointerEvents = 'auto';
                    input.parentElement.style.opacity = '1'; // Restore full opacity
                    input.parentElement.onclick = null;
                }
            });

            // Enable date input
            const dateInput = document.getElementById('assessmentDate');
            if (dateInput) {
                dateInput.disabled = false;
                dateInput.style.pointerEvents = 'auto';
            }

            // Enable barangay select
            const barangaySelect = document.getElementById('barangaySelect');
            if (barangaySelect) {
                barangaySelect.disabled = false;
                barangaySelect.style.cursor = 'pointer';
                barangaySelect.style.pointerEvents = 'auto';
            }

            // Enable all navigation buttons
            document.querySelectorAll('.btn-next, .btn-previous').forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            });

            // Show Save button
            const saveBtn = document.querySelector('.btn-submit');
            if (saveBtn) {
                saveBtn.style.display = '';
            }

            // Remove VIEW ONLY button if it exists
            const viewOnlyBtn = document.getElementById('viewOnlyBtn');
            if (viewOnlyBtn) {
                viewOnlyBtn.remove();
            }
        }

        function selectRadio(name, value, points) {
            // Prevent changes if assessment is locked
            if (allAssessments[currentBarangay]?.locked === true) {
                return;
            }

            const radioButton = document.getElementById(name + '_' + value);
            const radioKey = name + '_' + value;

            // Check if clicking the same radio that was already selected
            if (lastSelectedRadio[name] === radioKey) {
                // Uncheck it (like checkbox behavior)
                radioButton.checked = false;
                delete lastSelectedRadio[name];
            } else {
                // Uncheck all radios in this group first
                document.querySelectorAll(`input[name="${name}"]`).forEach(radio => {
                    radio.checked = false;
                });

                // Check the selected radio
                radioButton.checked = true;
                lastSelectedRadio[name] = radioKey;
            }

            // Update visual selection
            document.querySelectorAll(`input[name="${name}"]`).forEach(radio => {
                radio.parentElement.classList.toggle('selected', radio.checked);
            });

            calculateScores();
        }

        function toggleCheckbox(id) {
            // Prevent changes if assessment is locked
            if (allAssessments[currentBarangay]?.locked === true) {
                return;
            }

            const checkbox = document.getElementById(id);
            checkbox.checked = !checkbox.checked;
            checkbox.parentElement.classList.toggle('checked', checkbox.checked);
            calculateScores();
        }

        function calculateScores() {
            let section1 = 0, section2 = 0, section3 = 0, section4 = 0;
            
            // Section 1: Establishment (20%)
            const q1a = document.querySelector('input[name="q1a"]:checked');
            if (q1a && q1a.value !== 'none') section1 += 5;
            
            if (document.getElementById('q1b_antivaw')?.checked) section1 += 2;
            if (document.getElementById('q1b_gender')?.checked) section1 += 2;
            if (document.getElementById('q1b_crisis')?.checked) section1 += 1;
            if (document.getElementById('q1c_location')?.checked) section1 += 5;
            if (document.getElementById('q1d_room')?.checked) section1 += 5;
            
            // Section 2: Resources (20%)
            if (document.getElementById('q2a_table')?.checked) section2 += 1;
            if (document.getElementById('q2a_cabinet')?.checked) section2 += 1;
            if (document.getElementById('q2a_bed')?.checked) section2 += 1;
            if (document.getElementById('q2a_vehicle')?.checked) section2 += 1;
            
            if (document.getElementById('q2b_phone')?.checked) section2 += 2;
            if (document.getElementById('q2b_computer')?.checked) section2 += 1;
            if (document.getElementById('q2b_camera')?.checked) section2 += 1;
            if (document.getElementById('q2b_recorder')?.checked) section2 += 1;
            if (document.getElementById('q2b_firstaid')?.checked) section2 += 1;
            
            if (document.getElementById('q2c_logbook1')?.checked) section2 += 1.5;
            if (document.getElementById('q2c_logbook2')?.checked) section2 += 1.5;
            if (document.getElementById('q2c_intake')?.checked) section2 += 0.5;
            if (document.getElementById('q2c_referral')?.checked) section2 += 0.5;
            if (document.getElementById('q2c_feedback')?.checked) section2 += 0.5;
            if (document.getElementById('q2c_bpo')?.checked) section2 += 0.5;
            
            if (document.getElementById('q2d_directory')?.checked) section2 += 2;
            if (document.getElementById('q2d_handbook')?.checked) section2 += 1;
            if (document.getElementById('q2d_books')?.checked) section2 += 1;
            if (document.getElementById('q2d_bpo_flow')?.checked) section2 += 0.5;
            if (document.getElementById('q2d_vaw_flow')?.checked) section2 += 0.5;
            
            // Section 3: Policies (20%)
            if (document.getElementById('q3a_aip')?.checked) section3 += 5;
            if (document.getElementById('q3b_cert')?.checked) section3 += 5;
            if (document.getElementById('q3c_gad')?.checked) section3 += 5;
            if (document.getElementById('q3d_bdp')?.checked) section3 += 5;
            
            // Section 4: Accomplishments (40%)
            if (document.getElementById('q4a_annual')?.checked) section4 += 10;
            
            const q4b = document.querySelector('input[name="q4b"]:checked');
            if (q4b) {
                const val = parseFloat(q4b.value);
                section4 += val === 4 ? 10 : val === 3 ? 7.5 : val === 2 ? 5 : val === 1 ? 2.5 : 0;
            }
            
            if (document.getElementById('q4c_database')?.checked) section4 += 10;
            
            const q4d = document.querySelector('input[name="q4d"]:checked');
            if (q4d) {
                const val = parseFloat(q4d.value);
                section4 += val === 2 ? 10 : val === 1 ? 5 : 0;
            }
            
            // Update displays
            const total = section1 + section2 + section3 + section4;
            
            document.getElementById('score1').textContent = `${section1}/20`;
            document.getElementById('score2').textContent = `${section1}/20`;
            document.getElementById('score3').textContent = `${section2}/20`;
            document.getElementById('score4').textContent = `${section2}/20`;
            document.getElementById('score5').textContent = `${section3}/20`;
            document.getElementById('score6').textContent = `${section4}/40`;
            
            document.getElementById('finalScore').textContent = total.toFixed(1);
            document.getElementById('summaryScore1').textContent = section1.toFixed(1);
            document.getElementById('summaryScore2').textContent = section2.toFixed(1);
            document.getElementById('summaryScore3').textContent = section3.toFixed(1);
            document.getElementById('summaryScore4').textContent = section4.toFixed(1);
            
            // Save to assessment data
            if (assessmentData) {
                assessmentData.section1Score = section1;
                assessmentData.section2Score = section2;
                assessmentData.section3Score = section3;
                assessmentData.section4Score = section4;
                assessmentData.totalScore = total;
            }
        }

        function saveAssessment() {
            if (!currentBarangay) {
                alert('No barangay selected');
                return;
            }

            // Check if already locked
            if (allAssessments[currentBarangay]?.locked === true) {
                alert('‚ö†Ô∏è This assessment is LOCKED and cannot be modified.\n\nOnce an assessment is saved, it cannot be changed.');
                return;
            }

            // Show confirmation dialog
            const confirmMsg = `‚ö†Ô∏è IMPORTANT CONFIRMATION\n\n` +
                `You are about to save the assessment for ${currentBarangay}.\n\n` +
                `Score: ${assessmentData.totalScore.toFixed(1)}/100\n\n` +
                `‚ö†Ô∏è PLEASE NOTE:\n` +
                `‚Ä¢ Once saved, this assessment will be LOCKED\n` +
                `‚Ä¢ You will NOT be able to modify it anymore\n` +
                `‚Ä¢ Make sure all your answers are correct\n\n` +
                `Do you want to proceed with saving?`;

            if (!confirm(confirmMsg)) {
                return; // User cancelled
            }

            // Collect ALL form answers
            const formData = {
                barangay: currentBarangay,
                date: document.getElementById('assessmentDate').value,
                assessor: getCurrentAssessorName(),
                status: 'completed',
                locked: true, // Mark as locked
                completedDate: new Date().toISOString(),

                // Save actual form values
                answers: {
                    q1a: document.querySelector('input[name="q1a"]:checked')?.value || null,
                    q1b_antivaw: document.getElementById('q1b_antivaw')?.checked || false,
                    q1b_gender: document.getElementById('q1b_gender')?.checked || false,
                    q1b_crisis: document.getElementById('q1b_crisis')?.checked || false,
                    q1c_location: document.getElementById('q1c_location')?.checked || false,
                    q1d_room: document.getElementById('q1d_room')?.checked || false,

                    q2a_table: document.getElementById('q2a_table')?.checked || false,
                    q2a_cabinet: document.getElementById('q2a_cabinet')?.checked || false,
                    q2a_bed: document.getElementById('q2a_bed')?.checked || false,
                    q2a_vehicle: document.getElementById('q2a_vehicle')?.checked || false,

                    q2b_phone: document.getElementById('q2b_phone')?.checked || false,
                    q2b_computer: document.getElementById('q2b_computer')?.checked || false,
                    q2b_camera: document.getElementById('q2b_camera')?.checked || false,
                    q2b_recorder: document.getElementById('q2b_recorder')?.checked || false,
                    q2b_firstaid: document.getElementById('q2b_firstaid')?.checked || false,

                    q2c_logbook1: document.getElementById('q2c_logbook1')?.checked || false,
                    q2c_logbook2: document.getElementById('q2c_logbook2')?.checked || false,
                    q2c_intake: document.getElementById('q2c_intake')?.checked || false,
                    q2c_referral: document.getElementById('q2c_referral')?.checked || false,
                    q2c_feedback: document.getElementById('q2c_feedback')?.checked || false,
                    q2c_bpo: document.getElementById('q2c_bpo')?.checked || false,

                    q2d_directory: document.getElementById('q2d_directory')?.checked || false,
                    q2d_handbook: document.getElementById('q2d_handbook')?.checked || false,
                    q2d_books: document.getElementById('q2d_books')?.checked || false,
                    q2d_bpo_flow: document.getElementById('q2d_bpo_flow')?.checked || false,
                    q2d_vaw_flow: document.getElementById('q2d_vaw_flow')?.checked || false,

                    q3a_aip: document.getElementById('q3a_aip')?.checked || false,
                    q3b_cert: document.getElementById('q3b_cert')?.checked || false,
                    q3c_gad: document.getElementById('q3c_gad')?.checked || false,
                    q3d_bdp: document.getElementById('q3d_bdp')?.checked || false,

                    q4a_annual: document.getElementById('q4a_annual')?.checked || false,
                    q4b: document.querySelector('input[name="q4b"]:checked')?.value || null,
                    q4c_database: document.getElementById('q4c_database')?.checked || false,
                    q4d: document.querySelector('input[name="q4d"]:checked')?.value || null
                },

                // Save scores
                section1Score: assessmentData.section1Score,
                section2Score: assessmentData.section2Score,
                section3Score: assessmentData.section3Score,
                section4Score: assessmentData.section4Score,
                totalScore: assessmentData.totalScore
            };

            // Save to all assessments
            allAssessments[currentBarangay] = formData;

            // Track edit history if this was an unlocked/edited assessment
            saveEditedAssessment(currentBarangay);

            // Save to localStorage
            saveToLocalStorage();

            // AUTO-BACKUP: Download individual barangay JSON
            setTimeout(() => {
                downloadIndividualBarangay(formData);
            }, 100);

            // AUTO-BACKUP: Download consolidated progress JSON
            setTimeout(() => {
                downloadConsolidatedProgress();
            }, 500);

            const completedCount = Object.keys(allAssessments).filter(b => allAssessments[b].status === 'completed').length;

            alert(`‚úÖ Assessment for ${currentBarangay} saved and LOCKED!\n\nScore: ${formData.totalScore.toFixed(1)}/100\n\nüîí This assessment is now locked.\n\nüìÅ FILES SAVED:\n‚úì ${currentBarangay}.json (current version)\n‚úì Progress_Latest.json (updated)\n\nüìÇ Smart Archive System:\n‚Ä¢ Main folder has latest files only\n‚Ä¢ Old versions auto-archived when edited\n‚Ä¢ Zero duplication, zero confusion\n‚Ä¢ Complete history preserved\n\nüí° TIP: Use only files from main folders for consolidation!`);

            backToDashboard();
        }

        function saveToLocalStorage() {
            try {
                const jsonString = JSON.stringify(allAssessments);

                // Validate before saving
                if (!jsonString || jsonString === '{}') {
                    console.warn('Attempting to save empty data');
                }

                localStorage.setItem('vaw_assessments', jsonString);
            } catch (error) {
                console.error('Error saving to localStorage:', error);

                // Check if quota exceeded
                if (error.name === 'QuotaExceededError') {
                    alert('‚ö†Ô∏è STORAGE FULL\n\nYour device storage is full.\n\n‚úÖ SOLUTIONS:\n‚Ä¢ Your auto-backups are safe in Downloads\n‚Ä¢ Clear browser data to free space\n‚Ä¢ Continue using - backups are automatic');
                } else {
                    alert('‚ö†Ô∏è SAVE ERROR\n\nCould not save to device storage.\n\n‚úÖ DON\'T WORRY:\n‚Ä¢ Auto-backup files were downloaded\n‚Ä¢ Data is safe in your Downloads folder\n‚Ä¢ You can continue working');
                }
            }
        }

        function loadFromLocalStorage() {
            try {
                const data = localStorage.getItem('vaw_assessments');
                if (!data) return {};

                const parsed = JSON.parse(data);

                // Validate structure
                if (typeof parsed !== 'object' || parsed === null) {
                    throw new Error('Invalid data structure');
                }

                return parsed;
            } catch (error) {
                console.error('Error loading localStorage:', error);

                // Attempt to backup corrupted data
                const corruptedData = localStorage.getItem('vaw_assessments');
                if (corruptedData) {
                    // Save corrupted data for recovery
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    try {
                        const blob = new Blob([corruptedData], { type: 'text/plain' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `CORRUPTED_BACKUP_${timestamp}.txt`;
                        a.click();
                    } catch (e) {
                        console.error('Could not save backup:', e);
                    }
                }

                alert('‚ö†Ô∏è DATA CORRUPTION DETECTED\n\nYour saved assessments may be corrupted.\n\n‚úÖ RECOVERY ACTIONS:\n‚Ä¢ A backup file has been downloaded\n‚Ä¢ Please send this file to your coordinator\n‚Ä¢ You can restore from your JSON backups\n\nThe app will now start fresh.');

                // Clear corrupted data
                localStorage.removeItem('vaw_assessments');
                return {};
            }
        }

        function loadAssessmentData(data) {
            assessmentData = data;

            // Restore ALL form values from saved data
            if (data.answers) {
                const answers = data.answers;

                // Restore radio buttons
                if (answers.q1a) {
                    const radio = document.getElementById('q1a_' + answers.q1a);
                    if (radio) {
                        radio.checked = true;
                        radio.parentElement.classList.add('selected');
                    }
                }

                // Restore checkboxes - Section 1
                if (answers.q1b_antivaw) document.getElementById('q1b_antivaw').checked = true;
                if (answers.q1b_gender) document.getElementById('q1b_gender').checked = true;
                if (answers.q1b_crisis) document.getElementById('q1b_crisis').checked = true;
                if (answers.q1c_location) document.getElementById('q1c_location').checked = true;
                if (answers.q1d_room) document.getElementById('q1d_room').checked = true;

                // Section 2a
                if (answers.q2a_table) document.getElementById('q2a_table').checked = true;
                if (answers.q2a_cabinet) document.getElementById('q2a_cabinet').checked = true;
                if (answers.q2a_bed) document.getElementById('q2a_bed').checked = true;
                if (answers.q2a_vehicle) document.getElementById('q2a_vehicle').checked = true;

                // Section 2b
                if (answers.q2b_phone) document.getElementById('q2b_phone').checked = true;
                if (answers.q2b_computer) document.getElementById('q2b_computer').checked = true;
                if (answers.q2b_camera) document.getElementById('q2b_camera').checked = true;
                if (answers.q2b_recorder) document.getElementById('q2b_recorder').checked = true;
                if (answers.q2b_firstaid) document.getElementById('q2b_firstaid').checked = true;

                // Section 2c
                if (answers.q2c_logbook1) document.getElementById('q2c_logbook1').checked = true;
                if (answers.q2c_logbook2) document.getElementById('q2c_logbook2').checked = true;
                if (answers.q2c_intake) document.getElementById('q2c_intake').checked = true;
                if (answers.q2c_referral) document.getElementById('q2c_referral').checked = true;
                if (answers.q2c_feedback) document.getElementById('q2c_feedback').checked = true;
                if (answers.q2c_bpo) document.getElementById('q2c_bpo').checked = true;

                // Section 2d
                if (answers.q2d_directory) document.getElementById('q2d_directory').checked = true;
                if (answers.q2d_handbook) document.getElementById('q2d_handbook').checked = true;
                if (answers.q2d_books) document.getElementById('q2d_books').checked = true;
                if (answers.q2d_bpo_flow) document.getElementById('q2d_bpo_flow').checked = true;
                if (answers.q2d_vaw_flow) document.getElementById('q2d_vaw_flow').checked = true;

                // Section 3
                if (answers.q3a_aip) document.getElementById('q3a_aip').checked = true;
                if (answers.q3b_cert) document.getElementById('q3b_cert').checked = true;
                if (answers.q3c_gad) document.getElementById('q3c_gad').checked = true;
                if (answers.q3d_bdp) document.getElementById('q3d_bdp').checked = true;

                // Section 4
                if (answers.q4a_annual) document.getElementById('q4a_annual').checked = true;

                if (answers.q4b) {
                    const radio = document.getElementById('q4b_' + answers.q4b);
                    if (radio) {
                        radio.checked = true;
                        radio.parentElement.classList.add('selected');
                    }
                }

                if (answers.q4c_database) document.getElementById('q4c_database').checked = true;

                if (answers.q4d) {
                    const radio = document.getElementById('q4d_' + answers.q4d);
                    if (radio) {
                        radio.checked = true;
                        radio.parentElement.classList.add('selected');
                    }
                }

                // Update visual state for all checkboxes
                document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                    cb.parentElement.classList.add('checked');
                });

                // Rebuild radio tracking for checked radios
                lastSelectedRadio = {};
                document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                    lastSelectedRadio[radio.name] = radio.id;
                });
            }

            calculateScores();
        }

        function submitAllData() {
            const completed = Object.keys(allAssessments).filter(b => allAssessments[b].status === 'completed').length;

            if (completed < 48) {
                alert(`You have only completed ${completed}/48 assessments.\n\nPlease complete all barangays before submitting.`);
                return;
            }

            const confirmed = confirm(`Submit all 48 assessments to Coordinator?\n\nThis will send an email notification to:\nrichmondrosete19@gmail.com`);

            if (!confirmed) return;

            // Create JSON export
            const exportData = {
                assessor: getCurrentAssessorName(),
                position: currentUser?.position || 'Assessor',
                municipality: 'Baggao, Cagayan',
                exportDate: new Date().toISOString(),
                totalAssessments: 48,
                completedAssessments: completed,
                assessments: allAssessments
            };

            // Show loading
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingOverlay';
            loadingDiv.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div style="color: white; margin-top: 20px;">Sending notification email...</div>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingDiv);

            // Send email via EmailJS
            const templateParams = {
                name: getCurrentAssessorName(),
                submission_date: new Date().toLocaleString(),
                to_email: 'richmondrosete19@gmail.com'
            };

            emailjs.send('service_ca84be8', 'template_exlk9ur', templateParams)
                .then(function(response) {
                    console.log('Email sent successfully!', response.status, response.text);

                    // Download JSON as backup
                    downloadJSON(exportData);

                    // Remove loading
                    document.getElementById('loadingOverlay').remove();

                    alert('‚úÖ Success!\n\n‚úì Email notification sent to coordinator\n‚úì JSON file downloaded as backup\n\nYour assessment submission is complete!');
                    location.reload();
                }, function(error) {
                    console.error('Email failed to send:', error);

                    // Still download JSON if email fails
                    downloadJSON(exportData);

                    // Remove loading
                    document.getElementById('loadingOverlay').remove();

                    alert('‚ö†Ô∏è Email notification failed to send.\n\nBut don\'t worry!\nJSON file has been downloaded to your device.\n\nPlease manually email this file to:\nrichmondrosete19@gmail.com');
                    location.reload();
                });
        }

        // ============================================
        // ENHANCED FILE SYSTEM - FOLDER CREATION & ORGANIZATION
        // ============================================

        /**
         * Check if running in Android Studio WebView with file interface
         */
        function isAndroidApp() {
            return typeof Android !== 'undefined' && Android !== null && typeof Android.saveFile === 'function';
        }

        /**
         * Check if running in MIT App Inventor
         */
        function isAppInventor() {
            return typeof window.AppInventor !== 'undefined' ||
                   (typeof window.webkit !== 'undefined' && window.webkit.messageHandlers);
        }

        /**
         * Check if File System Access API is available (Chrome/Edge 86+)
         */
        function supportsFileSystemAccess() {
            return 'showDirectoryPicker' in window;
        }

        // Store directory handle for reuse
        let rootDirectoryHandle = null;

        /**
         * IndexedDB helper to persist directory handle across page reloads
         */
        const DB_NAME = 'VAW_FileSystem';
        const DB_VERSION = 1;
        const STORE_NAME = 'directoryHandles';

        async function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };
            });
        }

        async function saveDirectoryHandle(handle) {
            try {
                const db = await openDB();
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                await store.put(handle, 'rootDirectory');
                console.log('‚úÖ Directory handle saved to IndexedDB');
            } catch (error) {
                console.error('Failed to save directory handle:', error);
            }
        }

        async function loadDirectoryHandle() {
            try {
                const db = await openDB();
                const transaction = db.transaction(STORE_NAME, 'readonly');
                const store = transaction.objectStore(STORE_NAME);

                return new Promise((resolve, reject) => {
                    const request = store.get('rootDirectory');
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                console.error('Failed to load directory handle:', error);
                return null;
            }
        }

        async function verifyPermission(handle, showPrompt = true) {
            const options = { mode: 'readwrite' };

            try {
                // Check if permission was already granted
                const queryResult = await handle.queryPermission(options);
                console.log(`üîç Permission query result: ${queryResult}`);

                if (queryResult === 'granted') {
                    return true;
                }

                // If not granted, request permission (this shows browser prompt)
                if (showPrompt) {
                    console.log('üîî Requesting permission from user...');
                    const requestResult = await handle.requestPermission(options);
                    console.log(`üîî Permission request result: ${requestResult}`);

                    if (requestResult === 'granted') {
                        return true;
                    } else {
                        console.warn('‚ö†Ô∏è User denied permission request');
                        alert(
                            '‚ö†Ô∏è FOLDER ACCESS DENIED\n\n' +
                            'You need to grant permission to save files to the folder.\n\n' +
                            'Click "Enable Folder Organization" again to select a new folder.'
                        );
                    }
                }

                return false;
            } catch (error) {
                console.error('‚ùå Error verifying permission:', error);
                return false;
            }
        }

        /**
         * Load saved directory handle on page load
         */
        async function initializeDirectoryHandle() {
            if (supportsFileSystemAccess()) {
                console.log('üîÑ Attempting to restore folder handle...');
                try {
                    const savedHandle = await loadDirectoryHandle();
                    if (savedHandle) {
                        console.log('üìÅ Found saved handle in IndexedDB');
                        // Verify permission before using (this will prompt user if needed)
                        const hasPermission = await verifyPermission(savedHandle, true);
                        if (hasPermission) {
                            rootDirectoryHandle = savedHandle;
                            console.log('‚úÖ Restored directory handle from previous session');
                            // Update UI to reflect folder is ready
                            updateFolderStatusUI();

                            // Show success message
                            setTimeout(() => {
                                const toast = document.createElement('div');
                                toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:15px 25px;border-radius:8px;z-index:10000;font-weight:bold;box-shadow:0 4px 6px rgba(0,0,0,0.1);';
                                toast.textContent = '‚úÖ Folder organization restored!';
                                document.body.appendChild(toast);
                                setTimeout(() => toast.remove(), 3000);
                            }, 1000);

                            return true;
                        } else {
                            console.warn('‚ö†Ô∏è Permission denied or revoked for saved directory');
                            // Clear the invalid handle from IndexedDB
                            await clearDirectoryHandle();
                            rootDirectoryHandle = null;

                            // Notify user
                            setTimeout(() => {
                                alert(
                                    '‚ö†Ô∏è FOLDER PERMISSION EXPIRED\n\n' +
                                    'Chrome has revoked access to your selected folder (security feature).\n\n' +
                                    'What to do:\n' +
                                    '1. Click "File Organization" button (üìÅ)\n' +
                                    '2. Click "Enable Folder Organization"\n' +
                                    '3. Re-select your folder\n' +
                                    '4. Click "Allow" when browser asks\n\n' +
                                    'Your files are safe in the folder!'
                                );
                            }, 1000);
                        }
                    } else {
                        console.log('‚ÑπÔ∏è No saved folder handle found (first use or cleared)');
                    }
                } catch (error) {
                    console.error('‚ùå Error initializing directory handle:', error);
                    rootDirectoryHandle = null;
                }
            } else {
                console.warn('‚ö†Ô∏è File System Access API not supported in this browser');
            }
            return false;
        }

        /**
         * Clear directory handle from IndexedDB
         */
        async function clearDirectoryHandle() {
            try {
                const db = await openDB();
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                await store.delete('rootDirectory');
                console.log('üóëÔ∏è Cleared directory handle from IndexedDB');
            } catch (error) {
                console.error('Failed to clear directory handle:', error);
            }
        }

        /**
         * Update folder status UI indicator
         */
        function updateFolderStatusUI() {
            // This will be called after folder is set/restored
            if (typeof checkFolderStatus === 'function') {
                checkFolderStatus();
            }
        }

        /**
         * Send file to MIT App Inventor via WebViewString
         */
        function sendToAppInventor(folder, filename, content) {
            // Format: SAVE_FILE|folder|filename|content
            const message = `SAVE_FILE|${folder}|${filename}|${content}`;

            try {
                // Try different methods to communicate with App Inventor
                if (typeof window.AppInventor !== 'undefined' && window.AppInventor.setWebViewString) {
                    window.AppInventor.setWebViewString(message);
                    console.log(`‚úÖ Sent to App Inventor: ${folder}/${filename}`);
                    return true;
                } else if (typeof window.webkit !== 'undefined' && window.webkit.messageHandlers) {
                    // For iOS App Inventor (if supported)
                    window.webkit.messageHandlers.appInventor.postMessage(message);
                    return true;
                } else {
                    // Fallback: Set location hash (App Inventor can monitor this)
                    window.location.hash = encodeURIComponent(message);
                    console.log(`‚úÖ Sent via hash to App Inventor: ${folder}/${filename}`);
                    return true;
                }
            } catch (error) {
                console.error('App Inventor communication error:', error);
                return false;
            }
        }

        /**
         * Save file using File System Access API (Modern Chrome/Edge)
         * Creates actual folders on the device
         */
        async function saveWithFileSystemAPI(filename, content, folder = 'barangay') {
            try {
                console.log(`üíæ Attempting to save: ${folder}/${filename}`);

                // Request directory picker on first use OR if handle is invalid
                if (!rootDirectoryHandle) {
                    console.log('üìÅ No folder handle - prompting user to select folder...');

                    const confirmed = confirm(
                        'üìÅ FOLDER ORGANIZATION\n\n' +
                        'Select a folder where your files will be saved.\n\n' +
                        'Click OK to choose folder.'
                    );

                    if (!confirmed) {
                        console.log('User cancelled folder selection');
                        return false;
                    }

                    rootDirectoryHandle = await window.showDirectoryPicker({
                        id: 'vaw-assessments',
                        mode: 'readwrite',
                        startIn: 'downloads'
                    });

                    // Save to IndexedDB for persistence across page reloads
                    await saveDirectoryHandle(rootDirectoryHandle);
                    console.log('‚úÖ Folder selected and saved');
                } else {
                    // Verify we still have permission to the saved folder
                    console.log('üîç Checking folder permissions...');
                    const hasPermission = await verifyPermission(rootDirectoryHandle, true);

                    if (!hasPermission) {
                        console.warn('‚ö†Ô∏è Permission lost, requesting new folder selection...');
                        // Clear old handle
                        await clearDirectoryHandle();

                        alert(
                            '‚ö†Ô∏è FOLDER ACCESS LOST\n\n' +
                            'Chrome has revoked access to your folder.\n\n' +
                            'Please select the same folder again to continue saving files there.\n\n' +
                            'Click OK to select folder.'
                        );

                        // Request new folder
                        rootDirectoryHandle = await window.showDirectoryPicker({
                            id: 'vaw-assessments',
                            mode: 'readwrite',
                            startIn: 'downloads'
                        });

                        // Save new handle to IndexedDB
                        await saveDirectoryHandle(rootDirectoryHandle);
                        console.log('‚úÖ New folder selected and saved');
                    } else {
                        console.log('‚úÖ Folder permission verified');
                    }
                }

                // Create main folder: VAW_Assessments
                console.log('üìÇ Creating/accessing VAW_Assessments folder...');
                const mainFolder = await rootDirectoryHandle.getDirectoryHandle('VAW_Assessments', { create: true });

                // Create subfolder (barangay, progress, or final)
                console.log(`üìÇ Creating/accessing ${folder} subfolder...`);
                const subFolder = await mainFolder.getDirectoryHandle(folder, { create: true });

                // Create and write the file
                console.log(`üìù Writing file: ${filename}...`);
                const fileHandle = await subFolder.getFileHandle(filename, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(content);
                await writable.close();

                console.log(`‚úÖ File saved successfully: VAW_Assessments/${folder}/${filename}`);

                // Show success toast
                const toast = document.createElement('div');
                toast.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#10b981;color:white;padding:15px 25px;border-radius:8px;z-index:10000;font-weight:bold;box-shadow:0 4px 6px rgba(0,0,0,0.1);';
                toast.textContent = `‚úÖ Saved to ${folder}/ folder`;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);

                return true;
            } catch (error) {
                console.error('‚ùå Error saving file:', error);

                if (error.name === 'AbortError') {
                    console.log('User cancelled folder selection');
                } else if (error.name === 'NotAllowedError') {
                    console.error('Permission denied to access folder');
                    alert(
                        '‚ùå PERMISSION DENIED\n\n' +
                        'Cannot access the selected folder.\n\n' +
                        'File saved to Downloads folder instead.\n\n' +
                        'To fix: Click "File Organization" and re-enable folder access.'
                    );
                    // Clear the invalid handle
                    rootDirectoryHandle = null;
                    await clearDirectoryHandle();
                } else {
                    console.error('File System API error:', error);
                    alert(
                        '‚ùå SAVE ERROR\n\n' +
                        `Error: ${error.message}\n\n` +
                        'File saved to Downloads folder instead.\n\n' +
                        'To retry: Click "File Organization" and check folder access.'
                    );
                    // On any error, clear handle so user can try again
                    rootDirectoryHandle = null;
                    await clearDirectoryHandle();
                }
                return false;
            }
        }

        /**
         * Enhanced save with folder structure
         * @param {string} filename - Name of the file
         * @param {string} content - JSON content
         * @param {string} folder - Subfolder (barangay, progress, or final)
         */
        async function saveToDesignatedFolder(filename, content, folder = 'barangay') {
            console.log(`üíæ Saving file: ${filename} to folder: ${folder}`);

            let savedToCustomFolder = false;

            // METHOD 1: Android Studio App (with JavascriptInterface)
            if (isAndroidApp()) {
                try {
                    const folderPath = `VAW_Assessments/${folder}`;
                    const success = Android.saveFile(folderPath, filename, content);

                    if (success) {
                        console.log(`‚úÖ File saved to Android app: ${folderPath}/${filename}`);
                        showFolderSuccessMessage(folder, filename);
                        savedToCustomFolder = true;
                    } else {
                        console.error('‚ùå Android save failed, trying next method');
                    }
                } catch (error) {
                    console.error('Android save error:', error);
                }
            }

            // METHOD 2: MIT App Inventor (via WebViewString)
            if (!savedToCustomFolder && isAppInventor()) {
                const success = sendToAppInventor(folder, filename, content);
                if (success) {
                    console.log(`‚úÖ Sent to MIT App Inventor: ${folder}/${filename}`);
                    showFolderSuccessMessage(folder, filename);
                    savedToCustomFolder = true;
                }
            }

            // METHOD 3: File System Access API (Modern browsers)
            if (!savedToCustomFolder && supportsFileSystemAccess() && rootDirectoryHandle) {
                const success = await saveWithFileSystemAPI(filename, content, folder);
                if (success) {
                    showFolderSuccessMessage(folder, filename);
                    savedToCustomFolder = true;
                }
            }

            // ALWAYS save to Downloads as backup (regardless of custom folder success)
            console.log('üíæ Saving backup copy to Downloads folder...');
            const prefixedFilename = `VAW_${folder.toUpperCase()}_${filename}`;

            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = prefixedFilename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            if (savedToCustomFolder) {
                console.log(`‚úÖ Dual save complete: Custom folder + Downloads backup`);
            } else {
                console.log(`‚úÖ File saved to Downloads folder`);
                showFolderFallbackMessage(folder, prefixedFilename);
            }

            return true;
        }

        /**
         * Show success message with folder information
         */
        function showFolderSuccessMessage(folder, filename) {
            console.log(`‚úÖ File organized in folder: ${folder}`);
            console.log(`üìÅ VAW_Assessments/${folder}/${filename}`);
        }

        /**
         * Show fallback message with organization instructions
         */
        function showFolderFallbackMessage(folder, filename) {
            console.log(`üì• Downloaded: ${filename}`);
            console.log(`üìÇ Please organize into folder: ${folder}`);
        }

        /**
         * Initialize folder structure (for Android/App Inventor)
         * Call this on app start
         */
        function initializeFolderStructure() {
            const folders = ['barangay', 'progress', 'final'];

            if (isAndroidApp()) {
                try {
                    folders.forEach(folder => {
                        Android.createFolder(`VAW_Assessments/${folder}`);
                    });
                    console.log('‚úÖ Folder structure initialized on Android');
                } catch (error) {
                    console.error('Folder creation error:', error);
                }
            }
        }

        /**
         * Request folder access permission (for File System API)
         */
        async function requestFolderPermission() {
            if (supportsFileSystemAccess()) {
                try {
                    const confirmed = confirm(
                        'üìÅ FOLDER ORGANIZATION\n\n' +
                        'This app can create organized folders for your JSON files:\n\n' +
                        'üìÇ VAW_Assessments/\n' +
                        '   ‚îú‚îÄ‚îÄ üìÇ barangay/ (individual assessments)\n' +
                        '   ‚îú‚îÄ‚îÄ üìÇ progress/ (progress backups)\n' +
                        '   ‚îî‚îÄ‚îÄ üìÇ final/ (final submission)\n\n' +
                        'Would you like to select a folder location?\n\n' +
                        '(Click OK to choose folder, or Cancel to use Downloads)'
                    );

                    if (confirmed) {
                        rootDirectoryHandle = await window.showDirectoryPicker({
                            id: 'vaw-assessments',
                            mode: 'readwrite',
                            startIn: 'downloads'
                        });

                        // Save to IndexedDB for persistence across page reloads
                        await saveDirectoryHandle(rootDirectoryHandle);

                        console.log('‚úÖ Folder access granted');

                        // Show success message
                        alert(
                            '‚úÖ FOLDER ORGANIZATION ENABLED!\n\n' +
                            'Your folder has been set successfully.\n\n' +
                            'üìÇ All files will now be saved to:\n' +
                            'VAW_Assessments/\n\n' +
                            '‚ú® This setting will persist even after you close the browser.\n\n' +
                            'You can now close this window.'
                        );

                        // Update UI
                        updateFolderStatusUI();

                        return true;
                    }
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error('Folder permission error:', error);
                        alert(
                            '‚ùå FOLDER SETUP FAILED\n\n' +
                            'Could not set up folder organization.\n\n' +
                            'Error: ' + error.message + '\n\n' +
                            'Files will be saved to Downloads folder instead.'
                        );
                    }
                }
            } else {
                alert(
                    '‚ö†Ô∏è NOT SUPPORTED\n\n' +
                    'Folder organization is not supported in this browser.\n\n' +
                    'Please use:\n' +
                    '‚Ä¢ Chrome 86+\n' +
                    '‚Ä¢ Edge 86+\n\n' +
                    'Files will be saved to Downloads folder.'
                );
            }
            return false;
        }

        // Initialize folder structure on app load
        setTimeout(() => {
            initializeFolderStructure();
            checkFolderStatus(); // Check folder status on load
        }, 1000);

        // ============================================
        // MODAL SYSTEM & NAVIGATION
        // ============================================

        /**
         * Open File Organization Modal
         */
        function openFileOrgModal() {
            document.getElementById('fileOrgModal').classList.add('active');
            checkFolderStatus(); // Refresh folder status when modal opens
        }

        /**
         * Open Data Recovery Modal
         */
        function openRecoveryModal() {
            document.getElementById('recoveryModal').classList.add('active');
        }

        /**
         * Open Main Menu Modal
         */
        function openMenuModal() {
            document.getElementById('menuModal').classList.add('active');
        }

        /**
         * Close Modal by ID
         */
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        /**
         * Close modal when clicking outside
         */
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                closeModal(event.target.id);
            }
        });

        // ============================================
        // FOLDER STATUS DETECTION
        // ============================================

        /**
         * Check if folders are already created
         * Detects folder organization status
         */
        async function checkFolderStatus() {
            const statusIndicator = document.getElementById('folderStatusIndicator');
            const statusIcon = document.getElementById('folderStatusIcon');
            const statusTitle = document.getElementById('folderStatusTitle');
            const statusList = document.getElementById('folderStatusList');

            // Reset classes
            statusIndicator.classList.remove('success', 'warning');

            // Check different folder organization methods
            let folderMethod = detectFolderMethod();

            if (folderMethod === 'file-system-api') {
                // File System Access API is available and folders exist
                try {
                    if (rootDirectoryHandle) {
                        // User has granted permission
                        const folders = await checkFilesInFolders();

                        statusIndicator.classList.add('success');
                        statusIcon.textContent = '‚úÖ';
                        statusTitle.textContent = 'Folder Organization: ACTIVE';

                        statusList.innerHTML = `
                            <div class="folder-item">
                                <span class="folder-item-icon">üìÅ</span>
                                <span><strong>Method:</strong> File System Access API</span>
                            </div>
                            <div class="folder-item">
                                <span class="folder-item-icon">üìÇ</span>
                                <span><strong>Location:</strong> User-selected folder</span>
                            </div>
                            <div class="folder-item">
                                <span class="folder-item-icon">‚úÖ</span>
                                <span><strong>Status:</strong> Folders created & ready</span>
                            </div>
                            ${folders}
                        `;
                    } else if (supportsFileSystemAccess()) {
                        // API available but not yet granted permission
                        statusIndicator.classList.add('warning');
                        statusIcon.textContent = 'üìÅ';
                        statusTitle.textContent = 'Folder Organization: Available';

                        statusList.innerHTML = `
                            <div class="folder-item">
                                <span class="folder-item-icon">‚ú®</span>
                                <span>File System Access API is available</span>
                            </div>
                            <div class="folder-item">
                                <span class="folder-item-icon">‚ö°</span>
                                <span>Click "Enable Folder Organization" to set up</span>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Folder status check error:', error);
                }

            } else if (folderMethod === 'android-app') {
                // Running in Android app with file system access
                statusIndicator.classList.add('success');
                statusIcon.textContent = '‚úÖ';
                statusTitle.textContent = 'Folder Organization: ACTIVE (Android)';

                statusList.innerHTML = `
                    <div class="folder-item">
                        <span class="folder-item-icon">üì±</span>
                        <span><strong>Method:</strong> Android Native App</span>
                    </div>
                    <div class="folder-item">
                        <span class="folder-item-icon">üìÇ</span>
                        <span><strong>Location:</strong> /VAW_Assessments/</span>
                    </div>
                    <div class="folder-item">
                        <span class="folder-item-icon">‚úÖ</span>
                        <span><strong>Status:</strong> Folders automatically created</span>
                    </div>
                    <div class="folder-item">
                        <span class="folder-item-icon">üìÅ</span>
                        <span>‚Ä¢ barangay/ (individual files)</span>
                    </div>
                    <div class="folder-item">
                        <span class="folder-item-icon">üìÅ</span>
                        <span>‚Ä¢ progress/ (backup files)</span>
                    </div>
                    <div class="folder-item">
                        <span class="folder-item-icon">üìÅ</span>
                        <span>‚Ä¢ final/ (submission files)</span>
                    </div>
                `;

            } else if (folderMethod === 'app-inventor') {
                // Running in MIT App Inventor
                statusIndicator.classList.add('success');
                statusIcon.textContent = '‚úÖ';
                statusTitle.textContent = 'Folder Organization: ACTIVE (App Inventor)';

                statusList.innerHTML = `
                    <div class="folder-item">
                        <span class="folder-item-icon">üîß</span>
                        <span><strong>Method:</strong> MIT App Inventor</span>
                    </div>
                    <div class="folder-item">
                        <span class="folder-item-icon">üìÇ</span>
                        <span><strong>Location:</strong> App-managed storage</span>
                    </div>
                    <div class="folder-item">
                        <span class="folder-item-icon">‚úÖ</span>
                        <span><strong>Status:</strong> Files organized by app</span>
                    </div>
                `;

            } else {
                // No folder organization available - browser fallback
                statusIndicator.classList.add('warning');
                statusIcon.textContent = '‚ö†Ô∏è';
                statusTitle.textContent = 'Folder Organization: Not Available';

                statusList.innerHTML = `
                    <div class="folder-item">
                        <span class="folder-item-icon">üì•</span>
                        <span><strong>Method:</strong> Browser Download (Fallback)</span>
                    </div>
                    <div class="folder-item">
                        <span class="folder-item-icon">üí°</span>
                        <span>Files will be prefixed with folder names</span>
                    </div>
                    <div class="folder-item">
                        <span class="folder-item-icon">üìù</span>
                        <span>Example: VAW_BARANGAY_Adaoag.json</span>
                    </div>
                    <div class="folder-item">
                        <span class="folder-item-icon">‚úã</span>
                        <span>You can organize files manually after download</span>
                    </div>
                `;
            }
        }

        /**
         * Detect which folder organization method is available
         */
        function detectFolderMethod() {
            if (isAndroidApp()) {
                return 'android-app';
            } else if (isAppInventor()) {
                return 'app-inventor';
            } else if (supportsFileSystemAccess() && rootDirectoryHandle) {
                return 'file-system-api';
            } else if (supportsFileSystemAccess()) {
                return 'file-system-api';
            } else {
                return 'browser-fallback';
            }
        }

        /**
         * Check files in folders (for File System API)
         */
        async function checkFilesInFolders() {
            try {
                const mainFolder = await rootDirectoryHandle.getDirectoryHandle('VAW_Assessments', { create: false });

                const folderCounts = {
                    barangay: 0,
                    progress: 0,
                    final: 0,
                    barangay_archive: 0,
                    progress_archive: 0
                };

                // Check each subfolder (including archive folders)
                for (const folderName of ['barangay', 'progress', 'final', 'barangay_archive', 'progress_archive']) {
                    try {
                        const subFolder = await mainFolder.getDirectoryHandle(folderName, { create: false });

                        // Count files in folder
                        let count = 0;
                        for await (const entry of subFolder.values()) {
                            if (entry.kind === 'file') {
                                count++;
                            }
                        }
                        folderCounts[folderName] = count;
                    } catch (error) {
                        // Folder doesn't exist yet
                        folderCounts[folderName] = 0;
                    }
                }

                return `
                    <div class="folder-item">
                        <span class="folder-item-icon">üìÅ</span>
                        <span>‚Ä¢ barangay/ (${folderCounts.barangay} current files)</span>
                    </div>
                    <div class="folder-item">
                        <span class="folder-item-icon">üìÅ</span>
                        <span>‚Ä¢ progress/ (${folderCounts.progress} current files)</span>
                    </div>
                    <div class="folder-item">
                        <span class="folder-item-icon">üìÅ</span>
                        <span>‚Ä¢ final/ (${folderCounts.final} files)</span>
                    </div>
                    <div class="folder-item">
                        <span class="folder-item-icon">üì¶</span>
                        <span>‚Ä¢ barangay_archive/ (${folderCounts.barangay_archive} backups)</span>
                    </div>
                    <div class="folder-item">
                        <span class="folder-item-icon">üì¶</span>
                        <span>‚Ä¢ progress_archive/ (${folderCounts.progress_archive} backups)</span>
                    </div>
                `;
            } catch (error) {
                console.error('Error checking folder contents:', error);
                return '<div class="folder-item"><span class="folder-item-icon">‚ö†Ô∏è</span><span>Folders not yet created</span></div>';
            }
        }

        function downloadJSON(data) {
            const json = JSON.stringify(data, null, 2);
            const dateStr = new Date().toISOString().split('T')[0];
            const filename = `VAW_Final_Submission_RichmondRosete_${dateStr}.json`;

            saveToDesignatedFolder(filename, json, 'final');
        }

        function downloadIndividualBarangay(barangayData) {
            const json = JSON.stringify(barangayData, null, 2);

            // Clean barangay name for filename (remove special chars)
            const cleanName = barangayData.barangay.replace(/[^a-zA-Z0-9]/g, '_');

            // SIMPLE FILENAME: Just barangay name (no timestamp)
            const filename = `${cleanName}.json`;

            // Archive old file before saving new one (if it exists)
            archiveOldFile(filename, 'barangay');

            saveToDesignatedFolder(filename, json, 'barangay');
        }

        function downloadConsolidatedProgress() {
            const completed = Object.keys(allAssessments).filter(b =>
                allAssessments[b].status === 'completed'
            );

            const progressData = {
                assessor: getCurrentAssessorName(),
                position: currentUser?.position || 'Assessor',
                municipality: 'Baggao, Cagayan',
                exportDate: new Date().toISOString(),
                progress: `${completed.length}/48`,
                totalAssessments: 48,
                completedAssessments: completed.length,
                pendingAssessments: 48 - completed.length,
                completedBarangays: completed,
                assessments: allAssessments
            };

            const json = JSON.stringify(progressData, null, 2);

            // SIMPLE FILENAME: Always "Progress_Latest.json"
            const filename = `Progress_Latest.json`;

            // Archive old progress file before saving new one
            archiveOldFile(filename, 'progress');

            saveToDesignatedFolder(filename, json, 'progress');
        }

        // ============================================
        // SMART ARCHIVE SYSTEM
        // ============================================

        /**
         * Archive old file before overwriting
         * Prevents data loss while keeping main folder clean
         */
        async function archiveOldFile(filename, folder = 'barangay') {
            if (!supportsFileSystemAccess() || !rootDirectoryHandle) {
                // If no folder system, skip archiving (files are timestamped in Downloads)
                return;
            }

            try {
                // Access main folder
                const mainFolder = await rootDirectoryHandle.getDirectoryHandle('VAW_Assessments', { create: false });
                const targetFolder = await mainFolder.getDirectoryHandle(folder, { create: false });

                // Check if file exists
                let oldFileHandle;
                try {
                    oldFileHandle = await targetFolder.getFileHandle(filename);
                } catch (error) {
                    // File doesn't exist yet (first save), skip archiving
                    console.log(`No existing file to archive: ${filename}`);
                    return;
                }

                // Read old file content
                const oldFile = await oldFileHandle.getFile();
                const oldContent = await oldFile.text();

                // Parse to check if it was edited
                let archiveLabel = 'ORIGINAL';
                let versionNum = '';
                try {
                    const oldData = JSON.parse(oldContent);
                    if (oldData.wasEdited) {
                        // This is already an edited version, count versions
                        const editCount = oldData.editHistory?.length || 0;
                        versionNum = `_v${editCount}`;
                        archiveLabel = 'EDITED';
                    }
                } catch (e) {
                    // If can't parse, just use ORIGINAL
                }

                // Create archive filename with timestamp
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
                const baseFilename = filename.replace('.json', '');
                const archiveFilename = `${baseFilename}_${timestamp}${versionNum}_${archiveLabel}.json`;

                // Create archive folder if not exists
                const archiveFolder = await mainFolder.getDirectoryHandle(`${folder}_archive`, { create: true });

                // Save to archive
                const archiveFileHandle = await archiveFolder.getFileHandle(archiveFilename, { create: true });
                const writable = await archiveFileHandle.createWritable();
                await writable.write(oldContent);
                await writable.close();

                console.log(`‚úÖ Archived: ${archiveFilename}`);

            } catch (error) {
                console.error('Error archiving file:', error);
                // Don't block the save if archiving fails
            }
        }

        // ============================================
        // DATA IMPORT & RECOVERY SYSTEM
        // ============================================

        /**
         * Auto-load latest Progress file from designated folder
         * NEW: Directly loads Progress_Latest.json (no scanning needed!)
         */
        async function autoLoadLatestProgress() {
            if (!supportsFileSystemAccess() || !rootDirectoryHandle) {
                alert('‚ùå No folder location set\n\nPlease enable "Folder Organization" first and select a folder location.');
                return;
            }

            try {
                // Show loading
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'autoLoadOverlay';
                loadingDiv.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999;">
                        <div class="loading">
                            <div class="spinner"></div>
                            <div style="color: white; margin-top: 20px;">Loading Progress_Latest.json...</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(loadingDiv);

                // Access progress folder
                const mainFolder = await rootDirectoryHandle.getDirectoryHandle('VAW_Assessments', { create: false });
                const progressFolder = await mainFolder.getDirectoryHandle('progress', { create: false });

                // Directly get Progress_Latest.json
                const fileHandle = await progressFolder.getFileHandle('Progress_Latest.json');
                const file = await fileHandle.getFile();

                // Remove loading
                document.getElementById('autoLoadOverlay').remove();

                // Confirm before loading
                const lastModified = new Date(file.lastModified).toLocaleString();
                const message = `üìÇ Found Progress File:\n\nProgress_Latest.json\nLast modified: ${lastModified}\n\nLoad this file?`;

                if (confirm(message)) {
                    // Load the file
                    const result = await importJSONData(file);

                    if (result.success) {
                        saveToLocalStorage();
                        updateDashboard();

                        alert(`‚úÖ AUTO-LOAD SUCCESS\n\nüìÅ Loaded: Progress_Latest.json\nüìÖ Last modified: ${lastModified}\n\nüìä Progress: ${result.barangays?.length || 0} barangays\n\nüíæ Data has been restored!`);
                    } else {
                        alert(`‚ùå LOAD FAILED\n\n${result.error}`);
                    }
                }

            } catch (error) {
                // Remove loading if still there
                const overlay = document.getElementById('autoLoadOverlay');
                if (overlay) overlay.remove();

                if (error.name === 'NotFoundError') {
                    alert('üìÇ Progress_Latest.json not found\n\nNo progress file exists yet.\n\nSave some assessments first to create the progress file!');
                } else {
                    console.error('Auto-load error:', error);
                    alert(`‚ùå AUTO-LOAD FAILED\n\n${error.message}\n\nPlease use "Load Data from JSON" to manually select a file.`);
                }
            }
        }

        /**
         * Handle file import from user selection
         * Supports multiple file selection
         */
        async function handleFileImport(event) {
            const files = event.target.files;

            if (!files || files.length === 0) {
                alert('No files selected');
                return;
            }

            console.log(`üì• Importing ${files.length} file(s)...`);

            let successCount = 0;
            let errorCount = 0;
            let importedBarangays = [];
            const errors = [];

            // Show loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'importLoadingOverlay';
            loadingDiv.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div style="color: white; margin-top: 20px;">Loading JSON files...</div>
                        <div style="color: white; margin-top: 10px; font-size: 14px;">Processing file <span id="fileProgress">0</span> of ${files.length}</div>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingDiv);

            // Process each file
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                document.getElementById('fileProgress').textContent = i + 1;

                try {
                    const result = await importJSONData(file);
                    if (result.success) {
                        successCount++;
                        if (result.barangays) {
                            importedBarangays = importedBarangays.concat(result.barangays);
                        }
                    } else {
                        errorCount++;
                        errors.push(`${file.name}: ${result.error}`);
                    }
                } catch (error) {
                    errorCount++;
                    errors.push(`${file.name}: ${error.message}`);
                    console.error(`Error importing ${file.name}:`, error);
                }
            }

            // Remove loading
            document.getElementById('importLoadingOverlay').remove();

            // Save merged data
            saveToLocalStorage();

            // Update dashboard
            updateDashboard();

            // Clear file input for next use
            event.target.value = '';

            // Show results
            const uniqueBarangays = [...new Set(importedBarangays)];
            let message = `üì• IMPORT COMPLETE\n\n`;
            message += `‚úÖ Successfully imported: ${successCount} file(s)\n`;

            if (errorCount > 0) {
                message += `‚ùå Failed: ${errorCount} file(s)\n`;
            }

            message += `\nüìä LOADED BARANGAYS:\n`;

            if (uniqueBarangays.length > 0) {
                message += `Total: ${uniqueBarangays.length} barangay(s)\n\n`;
                message += uniqueBarangays.slice(0, 10).join(', ');
                if (uniqueBarangays.length > 10) {
                    message += `\n...and ${uniqueBarangays.length - 10} more`;
                }
            } else {
                message += `No barangay data found`;
            }

            if (errors.length > 0 && errors.length <= 3) {
                message += `\n\n‚ö†Ô∏è ERRORS:\n${errors.join('\n')}`;
            }

            message += `\n\nüíæ Data has been restored to the app!`;

            alert(message);
        }

        /**
         * Import and validate JSON data from a single file
         */
        async function importJSONData(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = function(e) {
                    try {
                        const jsonData = JSON.parse(e.target.result);

                        // Validate structure
                        const validation = validateJSONStructure(jsonData);

                        if (!validation.valid) {
                            resolve({
                                success: false,
                                error: validation.error
                            });
                            return;
                        }

                        // Merge data based on type
                        const result = mergeAssessmentData(jsonData, file.name);

                        resolve({
                            success: true,
                            type: result.type,
                            barangays: result.barangays
                        });

                    } catch (error) {
                        resolve({
                            success: false,
                            error: 'Invalid JSON format: ' + error.message
                        });
                    }
                };

                reader.onerror = function() {
                    resolve({
                        success: false,
                        error: 'Failed to read file'
                    });
                };

                reader.readAsText(file);
            });
        }

        /**
         * Validate JSON structure
         */
        function validateJSONStructure(data) {
            // Type 1: Individual barangay assessment
            if (data.barangay && data.totalScore !== undefined) {
                return { valid: true, type: 'barangay' };
            }

            // Type 2: Progress/Final submission with assessments object
            if (data.assessments && typeof data.assessments === 'object') {
                return { valid: true, type: 'consolidated' };
            }

            // Type 3: Direct assessments object (backup format)
            if (typeof data === 'object' && !data.assessments && !data.barangay) {
                // Check if it looks like our assessments structure
                const keys = Object.keys(data);
                if (keys.length > 0) {
                    const firstItem = data[keys[0]];
                    if (firstItem && firstItem.barangay && firstItem.totalScore !== undefined) {
                        return { valid: true, type: 'direct' };
                    }
                }
            }

            return {
                valid: false,
                error: 'Unrecognized JSON format. Must be a VAW assessment file.'
            };
        }

        /**
         * Merge imported data with existing data
         * Prevents overwriting existing data unless explicitly confirmed
         */
        function mergeAssessmentData(jsonData, filename) {
            const validation = validateJSONStructure(jsonData);
            const importedBarangays = [];
            let merged = 0;
            let skipped = 0;

            if (validation.type === 'barangay') {
                // Single barangay file
                const barangayName = jsonData.barangay;

                if (allAssessments[barangayName]) {
                    // Already exists - ask to overwrite
                    const overwrite = confirm(
                        `‚ö†Ô∏è OVERWRITE WARNING\n\n` +
                        `Barangay "${barangayName}" already has data.\n\n` +
                        `Existing score: ${allAssessments[barangayName].totalScore?.toFixed(1) || 'N/A'}\n` +
                        `Import score: ${jsonData.totalScore?.toFixed(1) || 'N/A'}\n\n` +
                        `Do you want to OVERWRITE the existing data?`
                    );

                    if (overwrite) {
                        allAssessments[barangayName] = jsonData;
                        merged++;
                        importedBarangays.push(barangayName);
                        console.log(`‚úÖ Overwritten: ${barangayName}`);
                    } else {
                        skipped++;
                        console.log(`‚è≠Ô∏è Skipped: ${barangayName}`);
                    }
                } else {
                    // New data - just add it
                    allAssessments[barangayName] = jsonData;
                    merged++;
                    importedBarangays.push(barangayName);
                    console.log(`‚úÖ Imported: ${barangayName}`);
                }

            } else if (validation.type === 'consolidated') {
                // Progress or final submission file
                const assessments = jsonData.assessments;

                Object.keys(assessments).forEach(barangayName => {
                    if (allAssessments[barangayName]) {
                        // Check if import has newer data
                        const existingDate = new Date(allAssessments[barangayName].completedDate || 0);
                        const importDate = new Date(assessments[barangayName].completedDate || 0);

                        if (importDate > existingDate) {
                            allAssessments[barangayName] = assessments[barangayName];
                            merged++;
                            importedBarangays.push(barangayName);
                            console.log(`‚úÖ Updated (newer): ${barangayName}`);
                        } else {
                            skipped++;
                            console.log(`‚è≠Ô∏è Skipped (older): ${barangayName}`);
                        }
                    } else {
                        allAssessments[barangayName] = assessments[barangayName];
                        merged++;
                        importedBarangays.push(barangayName);
                        console.log(`‚úÖ Imported: ${barangayName}`);
                    }
                });

            } else if (validation.type === 'direct') {
                // Direct assessments object
                Object.keys(jsonData).forEach(barangayName => {
                    if (allAssessments[barangayName]) {
                        skipped++;
                        console.log(`‚è≠Ô∏è Skipped (exists): ${barangayName}`);
                    } else {
                        allAssessments[barangayName] = jsonData[barangayName];
                        merged++;
                        importedBarangays.push(barangayName);
                        console.log(`‚úÖ Imported: ${barangayName}`);
                    }
                });
            }

            console.log(`üìä Merge complete: ${merged} merged, ${skipped} skipped`);

            // FIX: Ensure all completed assessments are locked (with alert)
            const fixedCount = fixDataConsistency(true); // Show alert for imported data
            if (fixedCount > 0) {
                console.log(`üîß Auto-fixed ${fixedCount} unlocked completed assessments`);
            }

            return {
                type: validation.type,
                merged: merged,
                skipped: skipped,
                barangays: importedBarangays
            };
        }

        /**
         * Clear all data with confirmation
         */
        function clearAllDataConfirm() {
            const completed = Object.keys(allAssessments).filter(b => allAssessments[b].status === 'completed').length;

            const confirmed = confirm(
                `‚ö†Ô∏è CLEAR ALL DATA\n\n` +
                `This will DELETE all assessment data from this device!\n\n` +
                `Current data:\n` +
                `‚Ä¢ ${completed} completed assessments\n` +
                `‚Ä¢ ${Object.keys(allAssessments).length} total barangays\n\n` +
                `üö® THIS CANNOT BE UNDONE!\n\n` +
                `Make sure you have downloaded your JSON backups first.\n\n` +
                `Do you really want to clear all data?`
            );

            if (!confirmed) {
                return;
            }

            // Double confirmation for safety
            const doubleCheck = confirm(
                `‚ö†Ô∏è FINAL CONFIRMATION\n\n` +
                `Are you ABSOLUTELY SURE?\n\n` +
                `All ${completed} assessments will be permanently deleted.\n\n` +
                `Click OK to DELETE everything, or Cancel to keep your data.`
            );

            if (!doubleCheck) {
                alert('‚úÖ Cancelled. Your data is safe.');
                return;
            }

            // Clear data
            allAssessments = {};
            localStorage.removeItem('vaw_assessments');
            updateDashboard();

            alert(`üóëÔ∏è ALL DATA CLEARED\n\nAll assessments have been deleted from this device.\n\nYou can restore from JSON backups using "Load Data from JSON" if needed.`);

            // Reload page for fresh start
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        /**
         * Export all current data as backup
         */
        function exportAllDataAsBackup() {
            if (Object.keys(allAssessments).length === 0) {
                alert('No data to export');
                return;
            }

            const backupData = {
                backupDate: new Date().toISOString(),
                backupType: 'Full Backup',
                assessor: getCurrentAssessorName(),
                totalBarangays: Object.keys(allAssessments).length,
                assessments: allAssessments
            };

            const json = JSON.stringify(backupData, null, 2);
            const dateStr = new Date().toISOString().split('T')[0];
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
            const filename = `BACKUP_AllData_${dateStr}_${timestamp}.json`;

            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert(`‚úÖ BACKUP CREATED\n\nFile: ${filename}\n\nContains ${Object.keys(allAssessments).length} barangay assessments\n\nKeep this file safe for data recovery!`);
        }

        // ============================================
        // LONG-PRESS UNLOCK FUNCTIONALITY
        // ============================================

        // Raters database (same as login page)
        const raters = [
            { pin: "1001", name: "PNP BAGGAO", position: "ASSESSOR 1" },
            { pin: "1002", name: "MLGOO", position: "ASSESSOR 2" },
            { pin: "1003", name: "MSWDO1", position: "ASSESSOR 3" },
            { pin: "1004", name: "MSDWDO2", position: "ASSESSOR 4" },
            { pin: "1005", name: "WOMEN'S ORG", position: "ASSESSOR 5" },
            { pin: "1006", name: "SB REPRESENTATIVE", position: "ASSESSOR 6" },
            { pin: "1007", name: "CHAIRMAN (PS)", position: "ASSESSOR 7" },
            { pin: "1008", name: "MHO", position: "ASSESSOR 8" },
            { pin: "1009", name: "GAD FOCAL PERSON", position: "ASSESSOR 9" }
        ];

        let longPressTimer = null;
        let longPressProgress = 0;
        let longPressBarangay = null;
        let longPressCard = null;
        const LONG_PRESS_DURATION = 3000; // 3 seconds

        /**
         * Initialize long-press detection on a card
         */
        function initLongPress(card, barangayName) {
            let progressRing = null;
            let progressCircle = null;
            let touchIdentifier = null;
            let isLongPressing = false;

            // Add mobile-specific styles to prevent interference (only on touch devices)
            if ('ontouchstart' in window) {
                card.style.webkitTouchCallout = 'none';
                card.style.touchAction = 'none';
            }
            // Universal styles to prevent text selection during long-press
            card.style.webkitUserSelect = 'none';
            card.style.userSelect = 'none';

            const startLongPress = (e) => {
                // Only trigger on locked assessments
                const assessment = allAssessments[barangayName];
                if (!assessment || assessment.locked !== true) {
                    return;
                }

                // Prevent default behaviors (context menu, text selection, etc.)
                e.preventDefault();
                e.stopPropagation();

                // Mark that we're starting a long-press
                isLongPressing = true;

                // For touch events, store the touch identifier
                if (e.type === 'touchstart' && e.changedTouches && e.changedTouches.length > 0) {
                    touchIdentifier = e.changedTouches[0].identifier;
                }

                console.log(`üñ±Ô∏è Long-press started for ${barangayName} (${e.type})`);

                longPressBarangay = barangayName;
                longPressCard = card;

                // Create progress ring
                progressRing = document.createElement('div');
                progressRing.className = 'long-press-progress active';
                progressRing.innerHTML = `
                    <svg width="80" height="80">
                        <circle class="progress-bg" cx="40" cy="40" r="36"></circle>
                        <circle class="progress-fill" cx="40" cy="40" r="36"></circle>
                    </svg>
                `;
                card.appendChild(progressRing);
                progressCircle = progressRing.querySelector('.progress-fill');

                // Add pressing class
                card.classList.add('pressing');

                // Start timer
                const startTime = Date.now();
                longPressTimer = setInterval(() => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / LONG_PRESS_DURATION, 1);
                    longPressProgress = progress;

                    // Update progress ring
                    const dashOffset = 226 - (progress * 226);
                    progressCircle.style.strokeDashoffset = dashOffset;

                    // Complete
                    if (progress >= 1) {
                        console.log(`‚úÖ Long-press completed for ${barangayName}`);
                        clearLongPress();
                        showUnlockModal(barangayName);
                    }
                }, 50);
            };

            const clearLongPress = (e) => {
                // For touch events, only clear if it's the same touch that started
                if (e && e.type.startsWith('touch') && e.changedTouches) {
                    const touch = Array.from(e.changedTouches).find(t => t.identifier === touchIdentifier);
                    if (!touch) {
                        return; // Different touch, ignore
                    }
                }

                if (longPressTimer) {
                    clearInterval(longPressTimer);
                    longPressTimer = null;
                    if (isLongPressing && longPressProgress < 1) {
                        console.log(`‚ùå Long-press cancelled for ${barangayName} (progress: ${(longPressProgress * 100).toFixed(0)}%)`);
                    }
                }

                longPressProgress = 0;
                touchIdentifier = null;
                isLongPressing = false;
                card.classList.remove('pressing');

                // Remove progress ring
                const existingRing = card.querySelector('.long-press-progress');
                if (existingRing) {
                    existingRing.remove();
                }
            };

            // Mouse events (for desktop)
            card.addEventListener('mousedown', startLongPress);
            card.addEventListener('mouseup', clearLongPress);
            card.addEventListener('mouseleave', clearLongPress);

            // Double-click shortcut for PC users (alternative to long-press)
            card.addEventListener('dblclick', (e) => {
                const assessment = allAssessments[barangayName];
                if (assessment && assessment.locked === true) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log(`üñ±Ô∏è Double-click unlock triggered for ${barangayName}`);
                    clearLongPress(); // Clear any ongoing long-press
                    showUnlockModal(barangayName);
                }
            });

            // Touch events (for mobile) - passive: false allows preventDefault
            card.addEventListener('touchstart', startLongPress, { passive: false });
            card.addEventListener('touchend', clearLongPress, { passive: false });
            card.addEventListener('touchcancel', clearLongPress, { passive: false });
            card.addEventListener('touchmove', clearLongPress, { passive: false });

            // Prevent context menu on long press (mobile browsers)
            card.addEventListener('contextmenu', (e) => {
                const assessment = allAssessments[barangayName];
                if (assessment && assessment.locked === true) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            });
        }

        /**
         * Show unlock modal
         */
        function showUnlockModal(barangayName) {
            longPressBarangay = barangayName;

            // Set barangay name
            document.getElementById('unlockBarangayName').textContent = `üìç ${barangayName}`;

            // Clear PIN inputs
            const pinBoxes = document.querySelectorAll('.unlock-pin-box');
            pinBoxes.forEach(box => box.value = '');

            // Hide error
            document.getElementById('unlockError').classList.remove('show');

            // Show modal
            document.getElementById('unlockModal').classList.add('show');

            // Focus first PIN box
            setTimeout(() => {
                document.getElementById('unlockPin1').focus();
            }, 100);

            // Setup PIN box auto-tab
            setupUnlockPinBoxes();
        }

        /**
         * Close unlock modal
         */
        function closeUnlockModal() {
            document.getElementById('unlockModal').classList.remove('show');
            longPressBarangay = null;
        }

        /**
         * Setup PIN box auto-tab functionality
         */
        function setupUnlockPinBoxes() {
            const pinBoxes = document.querySelectorAll('.unlock-pin-box');

            pinBoxes.forEach((box, index) => {
                // Remove old listeners by cloning
                const newBox = box.cloneNode(true);
                box.parentNode.replaceChild(newBox, box);
            });

            // Re-query after cloning
            const newPinBoxes = document.querySelectorAll('.unlock-pin-box');

            newPinBoxes.forEach((box, index) => {
                // Auto-tab to next box on input
                box.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    if (this.value.length === 1 && index < newPinBoxes.length - 1) {
                        newPinBoxes[index + 1].focus();
                    }
                });

                // Handle backspace
                box.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && this.value === '' && index > 0) {
                        newPinBoxes[index - 1].focus();
                    }
                    // Submit on Enter
                    if (e.key === 'Enter') {
                        verifyUnlockPin();
                    }
                });

                // Only allow numeric input
                box.addEventListener('keypress', function(e) {
                    if (e.key < '0' || e.key > '9') {
                        e.preventDefault();
                    }
                });

                // Select all on focus
                box.addEventListener('focus', function() {
                    this.select();
                });
            });
        }

        /**
         * Verify PIN and unlock assessment
         */
        function verifyUnlockPin() {
            const pin =
                document.getElementById('unlockPin1').value +
                document.getElementById('unlockPin2').value +
                document.getElementById('unlockPin3').value +
                document.getElementById('unlockPin4').value;

            const errorDiv = document.getElementById('unlockError');

            // Validate PIN length
            if (pin.length !== 4) {
                errorDiv.classList.add('show');
                return;
            }

            // Check if PIN is valid
            const rater = raters.find(r => r.pin === pin);

            if (!rater) {
                // Invalid PIN
                errorDiv.classList.add('show');

                // Shake PIN boxes
                const pinBoxes = document.querySelectorAll('.unlock-pin-box');
                pinBoxes.forEach(box => {
                    box.value = '';
                    box.style.animation = 'none';
                    setTimeout(() => {
                        box.style.animation = 'shake 0.5s ease';
                    }, 10);
                });

                document.getElementById('unlockPin1').focus();
                return;
            }

            // Valid PIN - unlock assessment
            unlockAssessment(longPressBarangay, rater);
        }

        /**
         * Unlock assessment and enable editing
         */
        function unlockAssessment(barangayName, unlockedBy) {
            const assessment = allAssessments[barangayName];

            if (!assessment) {
                alert('Assessment not found');
                closeUnlockModal();
                return;
            }

            // Store original data for edit history
            const originalData = JSON.parse(JSON.stringify(assessment));

            // Initialize edit history if not exists
            if (!assessment.editHistory) {
                assessment.editHistory = [];
            }

            // Add unlock event to history
            assessment.editHistory.push({
                action: 'unlocked',
                timestamp: new Date().toISOString(),
                unlockedBy: unlockedBy.name,
                unlockerPin: unlockedBy.pin,
                unlockerPosition: unlockedBy.position,
                originalScore: originalData.totalScore,
                originalData: originalData
            });

            // Remove lock
            assessment.locked = false;
            assessment.unlockedOn = new Date().toISOString();
            assessment.unlockedBy = unlockedBy.name;

            // Save to localStorage
            localStorage.setItem('vaw_assessments', JSON.stringify(allAssessments));

            // Close modal
            closeUnlockModal();

            // Update dashboard
            updateDashboard();

            // Show success message with auto-open
            const openNow = confirm(
                `‚úÖ ASSESSMENT UNLOCKED\n\n` +
                `üìç Barangay: ${barangayName}\n` +
                `üîì Unlocked by: ${unlockedBy.name}\n\n` +
                `‚ö†Ô∏è IMPORTANT:\n` +
                `‚Ä¢ You can now edit this assessment\n` +
                `‚Ä¢ When you save, current version will be archived\n` +
                `‚Ä¢ Edit history will track all changes\n` +
                `‚Ä¢ Original data safely preserved\n\n` +
                `Original score: ${originalData.totalScore.toFixed(1)}/100\n\n` +
                `üì¶ Archive System:\n` +
                `Current file ‚Üí moved to barangay_archive/\n` +
                `New edits ‚Üí saved to main barangay/ folder\n\n` +
                `Click OK to open and edit now, or Cancel to edit later.`
            );

            // Automatically open the assessment for editing
            if (openNow) {
                console.log(`üîì Opening ${barangayName} for editing...`);

                // Set current barangay
                currentBarangay = barangayName;

                // Remove any existing lock banner
                const existingBanner = document.getElementById('lockBanner');
                if (existingBanner) {
                    existingBanner.remove();
                }

                // Reset form first
                resetAllFormInputs();

                // Enable all inputs (unlocked!)
                enableAllFormInputs();

                // Load the assessment data
                loadAssessmentData(assessment);

                // Hide dashboard, show form
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('assessmentForm').classList.remove('hidden');

                // Set barangay in dropdown
                document.getElementById('barangaySelect').value = barangayName;

                // Enable Next button
                document.getElementById('nextBtn').disabled = false;

                // Scroll to top
                window.scrollTo(0, 0);

                console.log(`‚úÖ ${barangayName} loaded for editing`);
            }
        }

        /**
         * Save edited assessment with edit history
         */
        function saveEditedAssessment(barangayName) {
            const assessment = allAssessments[barangayName];

            if (!assessment.editHistory || assessment.editHistory.length === 0) {
                // Not an edited assessment, proceed normally
                return;
            }

            // Get the last unlock event
            const lastUnlock = assessment.editHistory.find(e => e.action === 'unlocked');

            if (!lastUnlock) {
                return;
            }

            // Add edit completion event
            assessment.editHistory.push({
                action: 'edited',
                timestamp: new Date().toISOString(),
                editedBy: currentUser?.name || 'Unknown',
                newScore: assessment.totalScore,
                originalScore: lastUnlock.originalScore,
                scoreDifference: assessment.totalScore - lastUnlock.originalScore
            });

            assessment.lastEditedOn = new Date().toISOString();
            assessment.wasEdited = true;

            // Save to localStorage
            localStorage.setItem('vaw_assessments', JSON.stringify(allAssessments));
        }

        // ============================================
        // FACTORY RESET SYSTEM (PIN-PROTECTED)
        // ============================================

        const ADMIN_RESET_PIN = "9999"; // Admin code for factory reset

        /**
         * Open Factory Reset Modal
         */
        function openFactoryResetModal() {
            // Clear PIN inputs
            const pinBoxes = document.querySelectorAll('#factoryResetModal .unlock-pin-box');
            pinBoxes.forEach(box => box.value = '');

            // Hide error
            document.getElementById('resetError').classList.remove('show');

            // Show modal
            document.getElementById('factoryResetModal').classList.add('show');

            // Focus first PIN box
            setTimeout(() => {
                document.getElementById('resetPin1').focus();
            }, 100);

            // Setup PIN box auto-tab
            setupResetPinBoxes();
        }

        /**
         * Close Factory Reset Modal
         */
        function closeFactoryResetModal() {
            document.getElementById('factoryResetModal').classList.remove('show');
        }

        /**
         * Setup PIN box auto-tab functionality for reset modal
         */
        function setupResetPinBoxes() {
            const pinBoxes = document.querySelectorAll('#factoryResetModal .unlock-pin-box');

            pinBoxes.forEach((box, index) => {
                // Remove old listeners by cloning
                const newBox = box.cloneNode(true);
                box.parentNode.replaceChild(newBox, box);
            });

            // Re-query after cloning
            const newPinBoxes = document.querySelectorAll('#factoryResetModal .unlock-pin-box');

            newPinBoxes.forEach((box, index) => {
                // Auto-tab to next box on input
                box.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    if (this.value.length === 1 && index < newPinBoxes.length - 1) {
                        newPinBoxes[index + 1].focus();
                    }
                });

                // Handle backspace
                box.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && this.value === '' && index > 0) {
                        newPinBoxes[index - 1].focus();
                    }
                    // Submit on Enter
                    if (e.key === 'Enter') {
                        verifyResetPin();
                    }
                });

                // Only allow numeric input
                box.addEventListener('keypress', function(e) {
                    if (e.key < '0' || e.key > '9') {
                        e.preventDefault();
                    }
                });

                // Select all on focus
                box.addEventListener('focus', function() {
                    this.select();
                });
            });
        }

        /**
         * Verify ADMIN PIN and proceed with factory reset
         */
        function verifyResetPin() {
            const pin =
                document.getElementById('resetPin1').value +
                document.getElementById('resetPin2').value +
                document.getElementById('resetPin3').value +
                document.getElementById('resetPin4').value;

            const errorDiv = document.getElementById('resetError');

            // Validate PIN length
            if (pin.length !== 4) {
                errorDiv.classList.add('show');
                return;
            }

            // Check if PIN matches ADMIN code
            if (pin !== ADMIN_RESET_PIN) {
                // Invalid PIN
                errorDiv.classList.add('show');

                // Shake PIN boxes
                const pinBoxes = document.querySelectorAll('#factoryResetModal .unlock-pin-box');
                pinBoxes.forEach(box => {
                    box.value = '';
                    box.style.animation = 'none';
                    setTimeout(() => {
                        box.style.animation = 'shake 0.5s ease';
                    }, 10);
                });

                document.getElementById('resetPin1').focus();
                return;
            }

            // Valid ADMIN PIN - proceed with confirmation
            closeFactoryResetModal();
            confirmFactoryReset();
        }

        /**
         * Triple confirmation before factory reset
         */
        function confirmFactoryReset() {
            // CONFIRMATION 1
            const confirm1 = confirm(
                `‚ö†Ô∏è FACTORY RESET - CONFIRMATION 1 OF 3\n\n` +
                `This will DELETE ALL DATA:\n\n` +
                `‚Ä¢ All ${Object.keys(allAssessments).length} assessments\n` +
                `‚Ä¢ All JSON files in folders\n` +
                `‚Ä¢ All archive files\n` +
                `‚Ä¢ All progress data\n\n` +
                `‚ùå THIS CANNOT BE UNDONE!\n\n` +
                `Do you want to continue?`
            );

            if (!confirm1) {
                alert('‚úÖ Factory Reset cancelled.');
                return;
            }

            // CONFIRMATION 2
            const confirm2 = confirm(
                `‚ö†Ô∏è FACTORY RESET - CONFIRMATION 2 OF 3\n\n` +
                `Are you ABSOLUTELY SURE?\n\n` +
                `All assessment data will be permanently deleted.\n` +
                `This is typically used for:\n` +
                `‚Ä¢ Testing\n` +
                `‚Ä¢ Demo purposes\n` +
                `‚Ä¢ Starting fresh\n\n` +
                `Continue with factory reset?`
            );

            if (!confirm2) {
                alert('‚úÖ Factory Reset cancelled.');
                return;
            }

            // CONFIRMATION 3 - Final
            const confirm3 = confirm(
                `üö® FINAL WARNING - CONFIRMATION 3 OF 3\n\n` +
                `LAST CHANCE TO CANCEL!\n\n` +
                `Clicking OK will:\n` +
                `‚Ä¢ Delete ALL localStorage data\n` +
                `‚Ä¢ Clear ALL assessment files\n` +
                `‚Ä¢ Remove ALL backups\n` +
                `‚Ä¢ Reset system to factory state\n\n` +
                `‚ö†Ô∏è THIS IS IRREVERSIBLE!\n\n` +
                `Proceed with FACTORY RESET?`
            );

            if (!confirm3) {
                alert('‚úÖ Factory Reset cancelled. Your data is safe.');
                return;
            }

            // All confirmations passed - execute factory reset
            executeFactoryReset();
        }

        /**
         * Execute complete factory reset
         */
        async function executeFactoryReset() {
            console.log('üîß Executing Factory Reset...');

            // Show loading overlay
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'factoryResetOverlay';
            loadingDiv.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 99999; flex-direction: column;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div style="color: white; margin-top: 20px; font-size: 18px; font-weight: 600;">üîß Factory Reset in Progress...</div>
                        <div style="color: white; margin-top: 10px; font-size: 14px;">Deleting all data and files...</div>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingDiv);

            try {
                // Step 1: Delete all JSON files from folders
                await deleteAllJSONFiles();

                // Step 2: Clear localStorage
                localStorage.removeItem('vaw_assessments');
                localStorage.removeItem('vaw_login_session');

                // Step 3: Clear IndexedDB (directory handles)
                try {
                    const db = await openDB();
                    const transaction = db.transaction('directoryHandles', 'readwrite');
                    const store = transaction.objectStore('directoryHandles');
                    await store.clear();
                    console.log('‚úÖ IndexedDB cleared');
                } catch (e) {
                    console.log('‚ö†Ô∏è IndexedDB clear skipped (may not exist)');
                }

                // Step 4: Reset global state
                allAssessments = {};
                rootDirectoryHandle = null;

                // Remove loading
                document.getElementById('factoryResetOverlay').remove();

                // Success message
                alert(
                    `‚úÖ FACTORY RESET COMPLETE!\n\n` +
                    `All data has been deleted:\n` +
                    `‚Ä¢ Assessment data: Cleared\n` +
                    `‚Ä¢ JSON files: Deleted\n` +
                    `‚Ä¢ Archive files: Deleted\n` +
                    `‚Ä¢ Progress files: Deleted\n\n` +
                    `The system has been reset to factory state.\n\n` +
                    `You will now be redirected to the login page.`
                );

                // Redirect to login
                setTimeout(() => {
                    window.location.href = 'START_HERE.html';
                }, 1000);

            } catch (error) {
                console.error('Factory reset error:', error);
                document.getElementById('factoryResetOverlay').remove();

                alert(
                    `‚ö†Ô∏è FACTORY RESET PARTIALLY COMPLETED\n\n` +
                    `localStorage data was cleared, but some file operations failed.\n\n` +
                    `Error: ${error.message}\n\n` +
                    `You may need to manually delete files from the VAW_Assessments folder.`
                );

                // Still redirect to login
                setTimeout(() => {
                    window.location.href = 'START_HERE.html';
                }, 2000);
            }
        }

        /**
         * Delete all JSON files from VAW_Assessments folders
         */
        async function deleteAllJSONFiles() {
            if (!supportsFileSystemAccess() || !rootDirectoryHandle) {
                console.log('‚ö†Ô∏è File system not available, skipping file deletion');
                return;
            }

            try {
                const mainFolder = await rootDirectoryHandle.getDirectoryHandle('VAW_Assessments', { create: false });

                // Folders to clear
                const foldersToDelete = ['barangay', 'progress', 'final', 'barangay_archive', 'progress_archive'];

                for (const folderName of foldersToDelete) {
                    try {
                        const folder = await mainFolder.getDirectoryHandle(folderName, { create: false });

                        // Delete all files in folder
                        const filesToDelete = [];
                        for await (const entry of folder.values()) {
                            if (entry.kind === 'file') {
                                filesToDelete.push(entry.name);
                            }
                        }

                        for (const fileName of filesToDelete) {
                            await folder.removeEntry(fileName);
                            console.log(`üóëÔ∏è Deleted: ${folderName}/${fileName}`);
                        }

                        console.log(`‚úÖ Cleared folder: ${folderName} (${filesToDelete.length} files)`);

                    } catch (error) {
                        console.log(`‚ö†Ô∏è Folder ${folderName} not found or error: ${error.message}`);
                    }
                }

                console.log('‚úÖ All JSON files deleted successfully');

            } catch (error) {
                console.error('Error deleting JSON files:', error);
                throw error;
            }
        }
    </script>
</body>
</html>
